<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宿舍分數計算器 - 優化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #0f2a4a;
            --accent: #4f9de8;
            --accent-dark: #347fd3;
            --success: #28a745;
            --success-dark: #218838;
            --warning: #ffc107;
            --warning-dark: #e0a800;
            --danger: #e84f4f;
            --danger-dark: #d33a3a;
            --text-light: #fff;
            --text-dark: #333;
            --card-bg: rgba(255, 255, 255, 0.08);
            --section-bg: rgba(30, 58, 95, 0.7);
            --required: #ff6b6b;
            --hint-pink: #ffb6c1;
            --language-bg: #90EE90; /* 淺綠色背景（不透明） */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            font-size: 18px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        header {
            text-align: center;
            padding: 25px;
            background: var(--section-bg);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            /* 以 clamp 做自適應，進一步縮細，確保任何裝置一行內完全顯示 */
            font-size: clamp(1.5rem, 4.8vw, 2.0rem);
            line-height: 1.1;
            margin-bottom: 8px;
            color: #fff;
            /* 降低光暈，避免視覺膨脹感 */
            text-shadow: 0 0 6px rgba(79, 157, 232, 0.5),
                         0 0 12px rgba(79, 157, 232, 0.35);
            position: relative;
            z-index: 2;
            letter-spacing: 0.5px;
            font-weight: 700;
            white-space: nowrap; /* 強制單行顯示 */
        }
        
        h1 i {
            color: #ffc107;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a0c8ff;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .form-section {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .section-title {
            font-size: 1.8rem;
            color: var(--accent);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
            font-size: 1.1rem;
        }
        
        .required::after {
            content: "*";
            color: var(--required) !important;
            margin-left: 4px;
            font-weight: bold;
        }
        
        .input-control {
            width: 100%;
            padding: 14px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 18px;
        }
        
        .input-control.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(232, 79, 79, 0.3);
        }
        
        .input-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79, 157, 232, 0.3);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .input-hint {
            font-size: 0.75rem; /* 縮小字體兩級 */
            color: var(--required);
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 0 16px; /* 由固定高度決定垂直尺寸 */
            font-size: 18px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            white-space: nowrap; /* 防止文字換行導致高度變大 */
            line-height: 44px; /* 垂直置中配合固定高度 */
        }
        
        /* 按鈕文字黑色邊框效果 */
        .btn span {
            position: relative;
            z-index: 2;
            text-shadow: none;
            line-height: 1; display: inline-block;
        }
        
        /* 特殊按鈕 - 無文字陰影 */
        .btn.no-text-shadow span {
            text-shadow: none !important;
        }
        
        /* 計算按鈕 - 醒目漸變設計 */
        .btn-primary {
            background: #0d6efd;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-primary:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0b5ed7;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .btn-primary:hover:before {
            opacity: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .btn-primary i {
            animation: pulse 2s infinite;
            font-size: 1em; /* 防止圖示放大令高度變化 */
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--text-dark);
        }
        
        .btn-warning:hover {
            background: var(--warning-dark);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }
        
        .result-section {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .result-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
            overflow-y: auto;
            font-size: 1.1rem;
        }
        
        .result-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
            font-size: 1.2rem;
        }
        
        .result-placeholder i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        .highlight-score {
            display: block;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px 0;
            color: var(--warning);
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 2px solid var(--warning);
        }
        
        .result-details {
            margin-top: 20px;
        }
        
        .result-item {
            padding: 18px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 1.1rem;
        }
        
        .result-label {
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 1.2rem;
        }
        
        .result-value {
            color: #fff;
        }
        
        .data-section {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            grid-column: 1 / -1;
        }
        
        .data-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 14px 14px 45px;
            font-size: 18px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            font-size: 1.3rem;
        }
        
        .data-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--accent);
            transition: all 0.3s;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent);
        }
        
        .card-date {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .card-score {
            font-size: 2rem;
            text-align: center;
            margin: 20px 0;
            color: var(--warning);
        }
        
        .card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .detail-item {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            padding: 12px;
        }
        
        .detail-label {
            font-size: 0.95rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-btn span {
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        .load-btn {
            background: var(--accent);
            color: white;
        }
        
        .load-btn:hover {
            background: var(--accent-dark);
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .delete-btn:hover {
            background: var(--danger-dark);
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
            grid-column: 1 / -1;
            font-size: 1.2rem;
        }
        
        .no-data i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        footer {
            text-align: center;
            padding: 30px 20px 20px;
            margin-top: 20px;
            color: #aaa;
        }
        
        /* 狀態欄優化 - 更細更精緻 */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.35);
            transition: transform .3s ease;
        }
        .status-bar.collapsed { transform: translateY(100%); }
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .status-message {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            color: yellow !important;
        }
        
        /* 強制狀態列文字黃色 */
        .status-message span, #statusText {
            color: yellow !important;
        }
        
        .status-actions {
            display: flex;
            gap: 10px;
        }
        .status-toggle { margin-left: 12px; }
        .status-toggle .status-btn { background: rgba(255,255,255,0.12); color: #fff; }
        
        .status-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-icon { margin-right: 8px; font-size: 1.05rem; line-height: 1; }
        
        .status-btn span {
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .data-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.3rem; /* 手機上再細少少 */
            }
        }
        
        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .section-title {
                font-size: 1.6rem;
            }
            
            body {
                font-size: 16px;
            }
            
            /* 手機版語言按鈕調整 */
            .language-toggle {
                top: 15px !important;
                right: 15px !important;
                font-size: 0.8rem !important;
                padding: 6px 12px !important;
            }
        }
        
        /* 打印样式 */
        @media print {
            body {
                background: white;
                color: black;
                padding: 10mm;
            }
            
            .container, .form-section, .result-section {
                box-shadow: none;
                background: white;
            }
            
            .button-group, .data-section, .status-bar, footer, .language-toggle {
                display: none;
            }
            
            .result-container {
                background: white;
                color: black;
                border: 1px solid #ccc;
            }
            
            .highlight-score {
                color: #1e3a5f;
            }
        }
        
        /* 標題裝飾效果 - 多色設計 */
        .header-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: hidden;
        }
        
        .decoration-circle {
            position: absolute;
            border-radius: 50%;
            animation: float 15s infinite ease-in-out;
        }
        
        .circle-1 {
            width: 120px;
            height: 120px;
            top: -30px;
            right: -30px;
            background: rgba(79, 157, 232, 0.1);
        }
        
        .circle-2 {
            width: 80px;
            height: 80px;
            bottom: -20px;
            left: -20px;
            background: rgba(255, 182, 193, 0.15);
        }
        
        .circle-3 {
            width: 60px;
            height: 60px;
            top: 50%;
            left: 20%;
            background: rgba(255, 193, 7, 0.15);
        }
        
        .circle-4 {
            width: 100px;
            height: 100px;
            bottom: 20px;
            right: 100px;
            background: rgba(40, 167, 69, 0.15);
        }
        
        .circle-5 {
            width: 90px;
            height: 90px;
            top: 20px;
            left: 15%;
            background: rgba(232, 79, 79, 0.15);
        }
        
        .circle-6 {
            width: 70px;
            height: 70px;
            top: 40%;
            right: 15%;
            background: rgba(159, 79, 232, 0.15);
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0);
            }
            25% {
                transform: translate(5px, 10px);
            }
            50% {
                transform: translate(-10px, 5px);
            }
            75% {
                transform: translate(8px, -7px);
            }
        }
        
        /* 新增標題閃光效果 - 速度減慢 */
        @keyframes shine {
            0% {
                background-position: -500px;
            }
            100% {
                background-position: 500px;
            }
        }
        
        h1 {
            position: relative;
        }
        
        h1:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 5s infinite linear; /* 從3s改為5s，使動畫變慢 */
            z-index: -1;
        }
        
        /* 語言切換按鈕 - 修正位置到右上角，避免覆蓋標題 */
        .language-toggle {
            position: fixed; /* 改為 fixed 定位 */
            top: 20px; /* 距離頂部 20px */
            right: 20px; /* 距離右邊 20px */
            background: var(--language-bg); /* 使用淺綠色背景 */
            color: #333; /* 深色文字 */
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            padding: 10px 18px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000; /* 確保在最上層 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: bold;
            text-shadow: none; /* 移除文字陰影 */
        }
        
        .language-toggle:hover {
            background: rgba(152, 251, 152, 0.95); /* 加深背景色 */
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        .language-toggle:active {
            transform: translateY(0) scale(0.98);
        }
            /* 簡化模式：只保留「儲存」＋「載入」按鈕 */
            .search-box { display: none !important; }
            #importBtn { display: none !important; }
            #savePdfBtn { display: none !important; }
            #exportBtn { display: none !important; }
            .status-actions { display: none !important; }
            .data-section { display: none !important; }
            /* 兩個按鈕水平排列（手機亦保持橫排） */
            @media (max-width: 600px) {
                .button-group { flex-direction: row !important; }
            }
            /* 強制兩個主要按鈕水平排列 */
            .button-group { flex-direction: row !important; justify-content: flex-start; align-items: center; gap: 12px; }
            /* 統一按鈕高度，避免不同語言造成尺寸變化 */
            .button-group .btn { height: 44px; padding: 0 16px; }
            .button-group .btn { flex: 0 0 auto; min-width: 160px; }
            /* 顯示調校控制：A+/A- + 亮度 */
            /* 顯示調校工具列（置於標題區右下角，不遮標題） */
            /* 工具列改為正常文流，不覆蓋內容，置中顯示於標題下方 */
            .display-controls { position: static; margin: 24px auto 28px; z-index: 1; display: flex; gap: 8px; align-items: center; justify-content: center; background: rgba(255,255,255,0.10); padding: 4px 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); max-width: 76%; }
            /* 讓 header 內部元素遵循文流 */
            header { position: relative; overflow: visible; }
            .display-label { font-size: 0.85rem; color: var(--text-light); margin-right: 4px; opacity: 0.9; }
            /* 使用現有 .btn 風格但縮細尺寸 */
            .btn-small { padding: 5px 8px; font-size: 13px; min-width: auto; line-height: 1; }
            /* 主題模式：亮／暗（覆蓋色板變數） */
            /* 粉色主題（Pastel Pink）統一風格 */
            .theme-light { 
                --primary: #f8f1f4; /* 粉白背景 */
                --primary-dark: #f0e4ea; /* 稍深粉白 */
                --accent: #f28fb1; /* 柔粉重點色 */
                --accent-dark: #d96a8f; /* 深粉重點色 */
                --success: #86c5a6; /* 柔和綠 */
                --warning: #f3c27a; /* 柔和黃 */
                --danger: #e07a8c; /* 柔和紅 */
                --text-light: #fff; /* 光明版主要文字改深色 */
                --text-dark: #111; 
                --card-bg: rgba(255, 255, 255, 0.95);
                --section-bg: rgba(255, 255, 255, 0.98);
            }
            .theme-light body { color: var(--text-light); }
            .theme-light .input-control { background: #ffffff; color: #333; border-color: #c88fa1; }
            .theme-light .section-title { color: #2b6cb0; border-color: #2b6cb0; }
            .theme-light .highlight-score { color: var(--warning); border-color: var(--warning); background: rgba(255,255,255,0.7); }
            .theme-light body { color: var(--text-dark); }
            .theme-light .form-section, .theme-light .result-section, .theme-light .data-section { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
            .theme-light .highlight-score { color: var(--warning); border-color: var(--warning); background: rgba(255,255,255,0.8); }
            /* 標題高度微縮 */
            header { padding: 12px 16px 20px !important; }
            h1 { font-size: 2.8rem !important; }
            /* 修正輸入欄位行高，避免字體縮放後擠壓或截斷 */
            .input-control { line-height: 1.5 !important; }
            /* 語言切換：浮動圓形按鈕（不影響版面），兼容瀏海安全距 */
            .language-toggle {
                position: fixed;
                top: calc(10px + env(safe-area-inset-top));
                right: calc(10px + env(safe-area-inset-right));
                width: 42px;
                height: 42px;
                border-radius: 50%;
                background: #f0f0f0; /* 實色，不透明 */
                color: #000;       /* 黑色文字 */
                border: 1px solid #ccc;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                z-index: 1000;
                box-shadow: 0 3px 8px rgba(0,0,0,0.20);
                font-weight: 700;
                text-shadow: none;
            }
            .language-toggle:hover { transform: translateY(-1px) scale(1.03); }
            .language-toggle:active { transform: translateY(0) scale(0.98); }
            @media (max-width: 600px) {
                .language-toggle { width: 36px; height: 36px; font-size: 0.8rem; }
            }
            /* QR 圓形按鈕（位於語言切換下方） */
            .qr-toggle {
                position: fixed;
                top: calc(10px + env(safe-area-inset-top) + 52px); /* 與語言鍵垂直對齊，下方留 10px */
                right: calc(10px + env(safe-area-inset-right));
                width: 42px;
                height: 42px;
                border-radius: 50%;
                background: #f0f0f0; /* 實色，不透明 */
                color: #000;       /* 黑色文字 */
                border: 1px solid #ccc;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                z-index: 1000;
                box-shadow: 0 3px 8px rgba(0,0,0,0.20);
                text-shadow: none;
                font-weight: 700;
            }
            .qr-toggle:hover { transform: translateY(-1px) scale(1.03); }
            .qr-toggle:active { transform: translateY(0) scale(0.98); }
            @media (max-width: 600px) {
                .language-toggle { width: 36px; height: 36px; }
                .qr-toggle { width: 36px; height: 36px; font-size: 0.9rem; top: calc(10px + env(safe-area-inset-top) + 45px); }
            }

            /* 工具列按鈕風格：跟輸入欄的淺藍透明效果，降低存在感 */
            .display-controls .btn,
            .display-controls .btn-small {
                background: rgba(255,255,255,0.12) !important;
                color: var(--text-light) !important;
                border: 1px solid rgba(255,255,255,0.25) !important;
                box-shadow: none !important;
            }
            .display-controls .btn-small:hover { background: rgba(255,255,255,0.16) !important; }
            .display-controls .btn-small { height: 26px; padding: 3px 8px; font-size: 13px; }
            /* 光明版下的工具列與文字可讀性優化 */
            .theme-light .display-controls { background: rgba(0,0,0,0.05) !important; border-color: rgba(0,0,0,0.10) !important; }
            .theme-light .display-controls .btn,
            .theme-light .display-controls .btn-small { background: rgba(0,0,0,0.06) !important; color: #222 !important; border: 1px solid rgba(0,0,0,0.12) !important; }
            /* 光明版整體文字顏色加深，避免過淺看不清 */
            .theme-light label,
            .theme-light .input-control,
            .theme-light .result-value,
            .theme-light .result-label { color: #222 !important; }
            /* 新增：較淺的黑暗版（theme-dark）配色，減低整體黑度但保持對比度 */
            .theme-dark {
                --primary: #27486f;           /* 由 #1e3a5f 提亮 */
                --primary-dark: #1a3658;      /* 由 #0f2a4a 提亮 */
                --accent: #7fb3e9;            /* 重點色偏淺藍，易讀 */
                --accent-dark: #4f94d9;
                --section-bg: rgba(30, 58, 95, 0.60);  /* 由 0.70 降到 0.60，少啲暗 */
                --card-bg: rgba(255, 255, 255, 0.06);  /* 稍微提亮卡片層 */
                --text-light: #f2f5f9;        /* 文字偏淺但唔係純白，減刺眼 */
            }
            /* 黑暗版下的輸入欄：微提亮背景與邊框，增可讀性 */
            .theme-dark .input-control {
                background: rgba(255, 255, 255, 0.12);
                border-color: rgba(255, 255, 255, 0.25);
                color: #f2f5f9;
            }
            /* 覆蓋定義：按你的要求重設深色／光明主題的配色與風格 */
            .theme-dark {
                /* 還原至原來的深色主題（作為基準版本） */
                --primary: #1e3a5f;
                --primary-dark: #0f2a4a;
                --accent: #4f9de8;
                --accent-dark: #347fd3;
                --section-bg: rgba(30, 58, 95, 0.70);
                --card-bg: rgba(255, 255, 255, 0.08);
                --text-light: #fff;
            }
            .theme-dark .input-control { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: var(--text-light); }
            
            .theme-light {
                /* 光明版：以深色主題為基礎整體提亮、透明度降低 */
                --primary: #2a5175; 
                --primary-dark: #184364; 
                --accent: #4f9de8; 
                --accent-dark: #347fd3; 
                --success: #86c5a6; 
                --warning: #f3c27a; 
                --danger: #e07a8c; 
                --text-light: #fff; 
                --text-dark: #111; 
                --card-bg: rgba(255, 255, 255, 0.12);
                --section-bg: rgba(30, 58, 95, 0.50);
            }
            .theme-light .input-control { background: rgba(255,255,255,0.12); color: #fff; border-color: rgba(255,255,255,0.30); }
            /* 覆蓋：光明版文字顏色保持白色，避免早前 #222 覆蓋 */
            .theme-light label,
            .theme-light .result-value,
            .theme-light .result-label { color: #fff !important; }
            /* 光明版全面提亮（整體更亮），並保持白色文字清晰可讀 */
            .theme-light {
                --primary: #8e9caf;          /* 亮：極淡粉白 */
                --primary-dark: #8794a4;     /* 亮：極淡暖白 */
                --accent: #7ec8ff;           /* 亮：柔藍重點色 */
                --accent-dark: #4f9de8;      /* 原藍作深重點 */
                --success: #8bd6b1;          /* 亮：柔綠 */
                --warning: #ffd07a;          /* 亮：柔黃 */
                --danger: #f59aa7;           /* 亮：柔紅 */
                --text-light: #fff;          /* 亮版仍用白字（你的要求） */
                --text-dark: #111;           
                --section-bg: rgba(30,58,95,0.65); /* 區塊背景加深透明度，讓白字有對比 */
                --card-bg: rgba(255,255,255,0.10);  /* 卡片微亮，不刺眼 */
            }
            .theme-light body { 
                background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important; 
                color: var(--text-light) !important; 
            }
            .theme-light .form-section, .theme-light .result-section, .theme-light .data-section { 
                background: var(--section-bg) !important; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important; 
            }
            /* 亮版下：輸入欄與按鈕跟隨整體風格，加深邊界提升可讀性 */
            .theme-light .input-control { 
                background: rgba(255,255,255,0.12) !important; 
                color: #fff !important; 
                border-color: rgba(255,255,255,0.30) !important; 
            }
            .theme-light .btn { 
                background: rgba(255,255,255,0.14) !important; 
                color: #fff !important; 
                border: 1px solid rgba(255,255,255,0.28) !important; 
                box-shadow: none !important; 
            }
            .theme-light .btn:hover { 
                background: rgba(255,255,255,0.18) !important; 
            }
            .theme-light .section-title { 
                color: var(--accent) !important; 
                border-color: var(--accent) !important; 
            }
            /* 需求：光明版輸入文字保持白色；按鈕用粉色與淺色系 */
            /* 1) 光明版：輸入區與標籤、提示等文字全部保持白色 */
            .theme-light label,
            .theme-light .input-hint,
            .theme-light .result-label,
            .theme-light .result-value { color: #fff !important; }
            .theme-light .input-control { color: #fff !important; }
            .theme-light .input-control::placeholder { color: rgba(255,255,255,0.75) !important; }
            /* 兼容部分瀏覽器的自動填充顏色 */
            .theme-light input:-webkit-autofill,
            .theme-light input:-webkit-autofill:focus {
                -webkit-text-fill-color: #fff !important;
                transition: background-color 5000s ease-in-out 0s !important;
            }

            /* 2) 光明版：按鈕用粉色與淺色系，保留原有類型但轉為柔和色階 */
            .theme-light .btn { 
                background: rgba(255,255,255,0.14) !important; 
                color: #fff !important; 
                border: 1px solid rgba(255,255,255,0.28) !important; 
                box-shadow: none !important; 
            }
            .theme-light .btn:hover { background: rgba(255,255,255,0.18) !important; }
            /* 類型色階（柔和粉系） */
            .theme-light .btn-primary { 
                background: #0d6efd !important; 
            }
            .theme-light .btn-success { background: #8bd6b1 !important; }
            .theme-light .btn-warning { background: #ffd07a !important; color: #333 !important; }
            .theme-light .btn-danger  { background: #f59aa7 !important; }
            /* 工具列按鈕也採用同一套柔和色階 */
            .theme-light .display-controls .btn,
            .theme-light .display-controls .btn-small { 
                background: rgba(255,255,255,0.14) !important; 
                color: #fff !important; 
                border: 1px solid rgba(255,255,255,0.28) !important; 
            }

            /* 3) 光明版：輸入框邊界加深一點，確保白字易讀 */
            .theme-light .input-control { 
                border-color: rgba(255,255,255,0.30) !important; 
                background: rgba(255,255,255,0.12) !important; 
            }
    /* 歡迎視窗樣式與動畫 */
.welcome-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 9999; opacity: 0; transition: opacity 420ms ease; }
.welcome-modal { width: min(520px, 92vw); border-radius: 20px; padding: 20px; max-height: 64vh; background: linear-gradient(135deg, rgba(30,58,138,0.5) 0%, rgba(59,130,246,0.5) 40%, rgba(168,85,247,0.5) 70%, rgba(245,158,11,0.5) 100%); color: #fff; box-shadow: 0 12px 40px rgba(0,0,0,0.35); transform: translateY(16px) scale(0.98); opacity: 0; animation: modalIn 640ms cubic-bezier(.2,.8,.2,1) forwards; position: relative; overflow: hidden; backdrop-filter: saturate(1.1) contrast(1.05); transition: opacity 360ms ease, transform 360ms ease; }
.welcome-modal::before { content: ""; position: absolute; inset: -40% -20% auto auto; width: 160%; height: 160%; background: radial-gradient(ellipse at top right, rgba(255,255,255,0.18), transparent 60%); transform: rotate(12deg); pointer-events: none; }
.welcome-title { font-size: 2.4rem; font-weight: 800; letter-spacing: .03em; display: flex; align-items: center; gap: 10px; }
.welcome-title .emoji { font-size: 2.4rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.25)); animation: bounce 1.4s ease-in-out infinite; }
.welcome-body { margin-top: 10px; font-size: 1.15rem; line-height: 1.75; opacity: 0.95; }
.welcome-actions { margin-top: 18px; display: flex; gap: 10px; justify-content: flex-end; align-items: center; } .welcome-actions .welcome-btn > * { line-height: 1; }
.welcome-btn { border: 0; border-radius: 12px; padding: 12px 18px; background: rgba(255,255,255,0.16); color: #fff; cursor: pointer; transition: transform .12s ease, background .2s ease; display: inline-flex; align-items: center !important; justify-content: center; line-height: 1; min-height: 44px; font-size: 1.08rem; }
.welcome-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.22); }
.welcome-btn.primary { background: #fff; color: #2b6cb0; font-weight: 700; display: inline-flex; align-items: center !important; justify-content: center; line-height: 1; min-height: 44px; font-size: 1.08rem; }
.welcome-btn.primary:hover { background: #f6f7fb; }
@keyframes modalIn { 0% { transform: translateY(16px) scale(0.98); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
/* 主題相容：在光明主題時調整對比 */
.theme-light .welcome-modal { background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(253,230,138,0.5) 30%, rgba(252,165,165,0.5) 60%, rgba(196,181,253,0.5) 100%); color: #2b6cb0; }
.theme-light .welcome-btn { background: rgba(43,108,176,0.12); color: #2b6cb0; }
.theme-light .welcome-btn.primary { background: #2b6cb0; color: #fff; }

/* 霧化彩帶/雪花畫布（只在歡迎視窗顯示） */
.confetti-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
.welcome-modal { z-index: 1; }

        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

  /* 語言為英文時，縮細「計算分數」按鈕文字避免變大 */
  html[data-lang="en"] #calcBtnText { font-size: 16px; }
  /* 英文時縮細「計算分數」文字，確保按鈕唔會變高 */
  html[data-lang="en"] #calcBtnText { font-size: 16px; }
  /* 保證兩個掣高度一致（圖示不影響高度） */
  .button-group .btn i { font-size: 1em; }
/* 3D 按鈕陰影樣式統一 */
.btn-3d {
  box-shadow: 0 6px 14px rgba(0,0,0,0.28), inset 0 1px 0 rgba(255,255,255,0.6);
  transform: translateY(0);
  transition: box-shadow .18s ease, transform .12s ease;
}
.btn-3d:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.32), inset 0 1px 0 rgba(255,255,255,0.65); transform: translateY(-1px); }
.btn-3d:active { box-shadow: 0 4px 10px rgba(0,0,0,0.24), inset 0 1px 0 rgba(255,255,255,0.55); transform: translateY(0); }

/* 讓提示文字僅保留文字本身，移除背景/陰影 */
.input-hint, .input-hint span#divisorHint {
  background: transparent !important;
  box-shadow: none !important;
  text-shadow: none !important;
  color: var(--hint-pink) !important; /* 使用淺粉紅提示色 */
}

/* 是/否選項可讀性強化：避免白底白字撞色 */
/* 與 .input-control 統一（深色主題預設） */
select {
  color: inherit !important;
  background: rgba(255, 255, 255, 0.1) !important; /* 與 .input-control 相同 */
  border: 1px solid rgba(255, 255, 255, 0.2) !important; /* 與 .input-control 相同 */
}
/* 選單的每個 option 在可支援的瀏覽器中也強制深色文字 */
select option { color: inherit !important; background: inherit !important; }

/* 深色主題下反轉顏色以保持對比 */
html[data-theme="dark"] select,
.theme-dark select { color: inherit !important; background: rgba(255, 255, 255, 0.1) !important; border-color: rgba(255, 255, 255, 0.2) !important; }
html[data-theme="dark"] select option,
.theme-dark select option { color: #fff !important; background: #1c1c1c !important; }

/* 焦點狀態：明顯的外框，提升可見度與可用性 */
select:focus { outline: 2px solid var(--accent) !important; outline-offset: 2px; }

/* 移動端（Android/部分瀏覽器）option 樣式支援有限，至少確保 select 本體文字為深色並且有邊框 */

/* 迷你確認浮層樣式（簡潔小巧） */
.mini-confirm { position: fixed; display: none; padding: 10px 12px; background: rgba(0,0,0,0.78); color: #fff; border-radius: 10px; box-shadow: 0 8px 16px rgba(0,0,0,0.28); font-size: 1.05rem; z-index: 2500; }
.mini-confirm .mini-lines { display: flex; flex-direction: column; line-height: 1.2; gap: 4px; }
.mini-confirm .mini-sub { opacity: 0.85; font-size: 0.92em; }
.mini-confirm .mini-actions { display: flex; gap: 8px; margin-top: 6px; justify-content: flex-end; }
.mini-confirm .mini-btn { background: rgba(255,255,255,0.18); color: #fff; border: 0; border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 0.95rem; }
.mini-confirm .mini-btn.ok { background: var(--warning); color: #333; }

</style>
        <style>
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 2000; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(720px, 92vw); max-height: 80vh; overflow: auto; background: var(--section-bg); color: var(--text-light); border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); z-index: 2001; display: none; }
        .modal header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: space-between; }
        .modal header h3 { font-size: 1.3rem; color: var(--accent); margin: 0; }
        .modal .modal-body { padding: 16px 20px; }
        .modal .modal-body ul { margin-left: 18px; }
        .modal .modal-foot { padding: 12px 20px 18px; border-top: 1px solid rgba(255,255,255,0.2); text-align: right; }
        .modal .close-btn { background: var(--warning); color: var(--text-dark); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 14px; cursor: pointer; }
        .modal .close-btn:hover { background: var(--warning-dark); }
        .modal .label { color: #a0c8ff; font-weight: bold; }
        @media (max-width: 600px) { .modal header h3 { font-size: 1.1rem; } .modal .modal-body { font-size: 0.95rem; } }
        
        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

</style>
<style>
.shake { animation: shake 320ms ease-in-out 2; }
@keyframes shake {
    0%   { transform: translateX(0); }
    25%  { transform: translateX(-4px); }
    50%  { transform: translateX(4px); }
    75%  { transform: translateX(-3px); }
    100% { transform: translateX(0); }
}

        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

</style>
<style>
.glow-yellow { box-shadow: 0 0 0 3px rgba(255,193,7,0.45), 0 0 12px rgba(255,193,7,0.55) !important; }
.glow-red { box-shadow: 0 0 0 3px rgba(232,79,79,0.45), 0 0 12px rgba(232,79,79,0.55) !important; }

        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

</style>
<style>
.disclaimer { color: #ffd07a; font-size: 0.95rem; margin-top: 8px; opacity: 0.9; }

        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

</style>
<style>
/* 在光明版，將總分改為深色字＋白底，提升對比 */
.theme-light .highlight-score {
  color: #1a2b44 !important;              /* 深藍字，對比高 */
  background: rgba(255,255,255,0.98) !important; /* 幾乎白底 */
  border-color: #1a2b44 !important;       /* 同色邊框 */
  text-shadow: none !important;           /* 移除光暈，字更銳利 */
}

        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

</style>
<style>
/* 淡藍框：令整體更專業、更易讀 */
.modal {
  border: 2px solid rgba(126, 200, 255, 0.45) !important; /* 外框淡藍 */
  box-shadow: 0 12px 28px rgba(79, 157, 232, 0.25), 0 4px 10px rgba(0,0,0,0.25) !important; /* 藍色陰影＋柔和立體感 */
}
.modal header, .modal .modal-foot {
  background: rgba(126, 200, 255, 0.08) !important; /* 頭／尾淡藍底 */
}
.modal .modal-body {
  background: rgba(126, 200, 255, 0.12) !important; /* 內容區淡藍半透明底 */
  border: 1px solid rgba(126, 200, 255, 0.30) !important; /* 內容區細框 */
  border-radius: 10px !important;
}

        /* ===== 光明版：只改紅圈位置文字為黑色 ===== */

/* ==== 計算分數按鈕：反光／光澤效果（醒目） ==== */
#calcBtn {
  backdrop-filter: saturate(1.25) blur(8px); /* 玻璃質感 */
  -webkit-backdrop-filter: saturate(1.25) blur(8px);

  position: relative;
  overflow: hidden;
  color: #331; /* 深色字提高對比 */
  background: linear-gradient(180deg, rgba(255,210,0,0.88) 0%, rgba(255,195,0,0.84) 40%, rgba(255,180,0,0.80) 70%, rgba(255,165,0,0.78) 100%);
  border: 1px solid rgba(255,255,255,0.55); /* 玻璃邊界 */
  box-shadow: 0 10px 24px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.75), inset 0 -1px 0 rgba(0,0,0,0.08);
  border-radius: 12px;
}
#calcBtn i { font-size: 1.38rem; filter: drop-shadow(0 1px 0 rgba(255,255,255,0.65)); }
#calcBtn #calcBtnText { font-size: 1.46rem; font-weight: 900; letter-spacing: .02em; }

/* 上半部「高光」反光層 */
#calcBtn::before {
  backdrop-filter: saturate(1.1);
  content: '';
  position: absolute; left: 0; top: 0; right: 0;
  height: 52%;
  background: linear-gradient(180deg, rgba(255,255,255,0.85) 0%, rgba(255,255,255,0.35) 60%, rgba(255,255,255,0.0) 100%);
  border-top-left-radius: 12px; border-top-right-radius: 12px;
  pointer-events: none;
}

/* 斜向掃光（Sheen） */
#calcBtn::after {
  content: '';
  position: absolute; top: -30%; left: -40%;
  width: 70%; height: 160%;
  background: linear-gradient(120deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.55) 45%, rgba(255,255,255,0.0) 90%);
  transform: rotate(18deg);
  filter: blur(1px);
  animation: calcBtnSheen 3.2s ease-in-out infinite;
  pointer-events: none;
}
@keyframes calcBtnSheen {
  0%   { transform: translateX(-40%) rotate(18deg); opacity: .0; }
  18%  { opacity: .85; }
  42%  { transform: translateX(160%) rotate(18deg); opacity: .0; }
  100% { transform: translateX(160%) rotate(18deg); opacity: .0; }
}

/* Hover 狀態：稍微抬起、加強光澤 */
#calcBtn:hover {
  backdrop-filter: saturate(1.35) blur(8px);
  transform: translateY(-2px); 
  box-shadow: 0 12px 26px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.9);
}

/* Active 狀態：按下的立體感 */
#calcBtn:active {
  transform: translateY(0);
  box-shadow: 0 6px 14px rgba(0,0,0,0.35), inset 0 2px 6px rgba(0,0,0,0.25);
}

/* 光明版配色微調（保持反光效果） */
.theme-light #calcBtn {
  color: #222 !important;
  background: linear-gradient(180deg, #ffd88c 0%, #ffcd70 40%, #f7b24c 70%, #e59a32 100%) !important;
  border-color: rgba(130, 80, 0, 0.32) !important;
}
.theme-light #calcBtn::before { background: linear-gradient(180deg, rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.45) 60%, rgba(255,255,255,0.0) 100%) !important; }

/* 令計算分數更搶眼：群組排版微調 */
.button-group #calcBtn { min-width: 180px; }

/* 保持其他警告按鈕正常 */
.button-group #resetBtn.btn-danger { /* 只示意，不改色 */ }

        .theme-light #calcBtn, .theme-light #resetBtn {
            color: #000 !important;
        }
        .theme-light #calcBtn span, .theme-light #resetBtn span {
            color: #000 !important;
            text-shadow: none !important;
        }
        .theme-light .disclaimer {
            color: #000 !important;
        }
        .theme-light #saveDataBtn,
        .theme-light button[onclick*="clearAllData"],
        .theme-light .btn-danger {
            color: #000 !important;
        }
        .theme-light #saveDataBtn span,
        .theme-light button[onclick*="clearAllData"] span,
        .theme-light .btn-danger span {
            color: #000 !important;
            text-shadow: none !important;
        }

    
        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

</style>
<style>
        .welcome-disclaimer {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            line-height: 1.4;
            text-align: center;
        }
        /* Light theme adjustment */
        .theme-light .welcome-disclaimer {
             color: rgba(43, 108, 176, 0.7);
             border-top-color: rgba(43, 108, 176, 0.15);
        }

        /* Animation classes */
        @keyframes float-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes shake-gentle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes doze-off { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(15deg); } 
            30% { transform: rotate(15deg); } 
            40% { transform: rotate(0deg); } 
            100% { transform: rotate(0deg); } 
        }

        .anim-float { display: inline-block; animation: float-gentle 2s ease-in-out infinite; }
        .anim-shake { display: inline-block; animation: shake-gentle 3s ease-in-out infinite; }
        .anim-doze { display: inline-block; animation: doze-off 4s ease-in-out infinite; transform-origin: bottom center; }

        .welcome-title {
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap !important;
            gap: 10px;
            width: 100%;
        }
        .welcome-title .welcome-text {
            white-space: nowrap !important;
            flex-shrink: 0;
            font-weight: bold;
        }
        .welcome-title .emoji {
            flex-shrink: 1;
            min-width: 0;
            font-size: 3rem;
            transition: font-size 0.3s ease;
        }
        @media (max-width: 480px) {
            .welcome-title .emoji { font-size: 1.8rem !important; }
            .welcome-title { gap: 5px; }
        }

</style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-decoration">
                <div class="decoration-circle circle-1"></div>
                <div class="decoration-circle circle-2"></div>
                <div class="decoration-circle circle-3"></div>
                <div class="decoration-circle circle-4"></div>
                <div class="decoration-circle circle-5"></div>
                <div class="decoration-circle circle-6"></div>
            </div>
            
            <h1><i class="fas fa-calculator"></i> <span id="appTitle">宿舍分數計算器</span></h1>
        <div class="display-controls" aria-label="顯示調校工具列">
            
            <button id="fontInc" class="btn btn-warning no-text-shadow btn-small btn-3d" title="Increase text"><i class="fas fa-plus"></i></button>
            <button id="fontDec" class="btn btn-warning no-text-shadow btn-small btn-3d" title="Decrease text"><i class="fas fa-minus"></i></button>
            
            <button id="themeToggle" class="btn btn-warning no-text-shadow btn-small btn-3d" title="Toggle theme"><i class="fas fa-circle-half-stroke"></i></button>
            
            <button id="infoBtn" type="button" class="btn btn-warning no-text-shadow btn-small btn-3d" title="使用須知"><i class="fas fa-info-circle"></i></button>
        </div>
        </header>
        
        <button id="languageToggle" class="language-toggle" aria-label="切換語言" style="background-color:#90EE90 !important; color:#000 !important; border:1px solid #7fd67f !important;">EN</button>
            <button id="qrButton" class="qr-toggle" aria-label="QR Code" style="background-color:#555 !important; color:#fff !important; border:1px solid #333 !important;">QR</button>
        
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-edit"></i> <span id="inputSectionTitle">輸入資料</span></h2>
                <div style="font-size: 0.8rem; color: var(--hint-pink); margin-top: -10px; margin-bottom: 15px; margin-left: 2px; opacity: 0.8;">
                    <span style="color: var(--required); font-weight: bold;">*</span> <span id="requiredLegend">代表必填資料</span>
                </div>
                
                <div class="form-group">
                    <label for="salary" class="required"><span id="salaryLabel">薪金（港幣）</span></label>
                    <input type="text" inputmode="decimal" id="salary" class="input-control" placeholder="例如：30000" min="0" oninput="sanitizeFloat(this)" onkeydown="blockFloatKeys(event)">
                </div>
                
                <div class="form-group">
                    <label for="divisor" class="required"><span id="divisorLabel">除數</span></label>
                    <input type="text" inputmode="decimal" id="divisor" class="input-control" value="538" min="1" oninput="sanitizeFloat(this)" onkeydown="blockFloatKeys(event)">
                    <div class="input-hint"><span id="divisorHint">目前預設值538，請參考最新宿舍手冊</span></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="hireDate" class="required"><span id="hireDateLabel">入職日期</span></label>
                        <input type="date" id="hireDate" class="input-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate" class="required"><span id="endDateLabel">截止日期</span></label>
                        <input type="date" id="endDate" class="input-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="spouse"><span id="spouseLabel">配偶在港居住？</span></label>
                    <select id="spouse" class="input-control">
                        <option value="no" selected><span id="spouseNo">否</span></option>
                        <option value="yes"><span id="spouseYes">是</span></option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="children"><span id="childrenLabel">子女人數</span></label>
                        <input type="text" inputmode="numeric" id="children" class="input-control" value="0" min="0" onkeydown="blockIntegerKeys(event)" oninput="sanitizeInteger(this)">
                    </div>
                    
                    <div class="form-group">
                        <label for="overseas"><span id="overseasLabel">海外就讀子女人數</span></label>
                        <input type="text" inputmode="numeric" id="overseas" class="input-control" value="0" min="0" onkeydown="blockIntegerKeys(event)" oninput="sanitizeInteger(this)">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newborn"><span id="newbornLabel">新生（在一個月內出生）</span></label>
                        <input type="text" inputmode="numeric" id="newborn" class="input-control" value="0" min="0" onkeydown="blockIntegerKeys(event)" oninput="sanitizeInteger(this)">
                    </div>
                    
                    <div class="form-group">
                        <label for="otherChildren"><span id="otherChildrenLabel">其他子女（除首名）</span></label>
                        <input type="text" inputmode="numeric" id="otherChildren" class="input-control" value="0" min="0" onkeydown="blockIntegerKeys(event)" oninput="sanitizeInteger(this)">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="instruction"><span id="instructionLabel">是否被指示離開宿舍？</span></label>
                        <select id="instruction" class="input-control">
                            <option value="no" selected><span id="instructionNo">否</span></option>
                            <option value="yes"><span id="instructionYes">是</span></option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="defect"><span id="defectLabel">宿舍有缺陷？</span></label>
                        <select id="defect" class="input-control">
                            <option value="no" selected><span id="defectNo">否</span></option>
                            <option value="yes"><span id="defectYes">是</span></option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="calcBtn" class="btn btn-warning btn-3d">
                        <i class="fas fa-calculator"></i> <span id="calcBtnText">計算分數</span>
                    </button>
                    <button id="resetBtn" class="btn btn-danger btn-3d">
                        <i class="fas fa-redo"></i> <span id="resetBtnText">重置表單</span>
                    </button>
                </div>
            </div>
            
            <div class="result-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> <span id="resultSectionTitle">計算結果</span></h2>
<p id="disclaimerResult" class="disclaimer">此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。</p>
                
                <div class="result-container">
                    <div class="result-placeholder" id="resultPlaceholder">
                        <i class="fas fa-file-alt"></i>
                        <p><span id="resultPlaceholderText">填寫左側表單後點擊「計算分數」</span></p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="saveDataBtn" class="btn btn-success btn-3d">
                        <i class="fas fa-save"></i> <span id="saveBtnText">儲存目前資料</span>
                    </button>
                    <button id="cancelSaveBtn" class="btn btn-danger no-text-shadow btn-3d" title="刪除已儲存的資料">
                        <i class="fas fa-ban"></i> <span id="cancelSaveText">取消儲存</span>
                    </button>
                    <select id="deleteSelect" class="input-control" style="max-width: 280px; display: none; margin-left: 10px;"></select>
                    <button id="loadBtn" class="btn btn-primary no-text-shadow btn-3d">
                        <i class="fas fa-download"></i> <span id="loadText">載入資料</span>
                    </button>
                    <select id="loadSelect" class="input-control" style="max-width: 280px; display: none; margin-left: 10px;"></select>
                </div>
            </div>
            
            <div class="data-section">
                <h2 class="section-title"><i class="fas fa-database"></i> <span id="dataSectionTitle">已儲存資料</span></h2>
                
                <div class="data-controls">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchData" class="input-control" placeholder="搜尋儲存資料...">
                    </div>
                    
                    <button id="exportBtn" class="btn btn-warning no-text-shadow btn-3d">
                        <i class="fas fa-file-export"></i> <span id="exportBtnText">匯出所有資料</span>
                    </button>
                    
                    <button id="importBtn" class="btn btn-primary btn-3d">
                        <i class="fas fa-file-import"></i> <span id="importBtnText">匯入資料</span>
                    </button>
                </div>
                
                <div class="data-container">
                    <div class="no-data" id="noDataMessage">
                        <i class="fas fa-database"></i>
                        <h3><span id="noDataTitle">尚未儲存任何資料</span></h3>
                        <p><span id="noDataHint">請使用「儲存目前資料」按鈕保存您的計算結果</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p id="disclaimerFooter" class="disclaimer">此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。</p>
        </footer>
    </div>
    
    <div class="status-bar">
        <div class="status-message">
            <span class="status-icon" aria-hidden="true">ℹ️</span><span id="statusText">系統準備就緒，請填寫表單開始計算</span>
        </div>
        <div class="status-actions">
            <button class="status-btn btn-3d" style="background: var(--accent); color: white;">
                <i class="fas fa-cloud"></i> <span id="backupStatus">自動備份已啟用</span>
            </button>
            <button class="status-btn btn-3d" style="background: var(--success); color: white;">
                <i class="fas fa-database"></i> <span id="dataStatus">已儲存 <span id="dataCount">0</span> 筆資料</span>
            </button>
            <div class="status-toggle">
                <button id="statusToggleBtn" class="status-btn btn-3d" type="button"><span id="statusToggleLabel">隱藏狀態列</span></button>
            </div>
        </div>
    </div>

    <script>
        // 語言設置
        let currentLang = 'zh';
        function updateStatusToggleLabel(){
            const bar = document.querySelector('.status-bar');
            const lab = document.getElementById('statusToggleLabel');
            if (!bar || !lab) return;
            const collapsed = bar.classList.contains('collapsed');
            lab.textContent = (currentLang === 'zh') ? (collapsed ? '顯示狀態列' : '隱藏狀態列') : (collapsed ? 'Show bar' : 'Hide bar');
        }
        function toggleStatusBarVisibility(){
            const bar = document.querySelector('.status-bar');
            if (!bar) return;
            bar.classList.toggle('collapsed');
            updateStatusToggleLabel();
        }
        
    function exitApp() {
        const toggleBtn = document.getElementById('statusToggleBtn');
        if (toggleBtn) toggleBtn.addEventListener('click', toggleStatusBarVisibility);
        updateStatusToggleLabel();
        try { window.close(); } catch(e) {}
    }

const translations = {
            'zh': {
                'appTitle': '宿舍分數計算器',
                'inputSectionTitle': '輸入資料',
                'salaryLabel': '薪金（港幣）',
                'salaryPlaceholder': '例如：30000',
                'requiredLegend': '代表必填資料',
                'divisorLabel': '除數',
                'divisorHint': '目前預設值538，請參考最新宿舍手冊',
                'hireDateLabel': '入職日期',
                'endDateLabel': '截止日期',
                'spouseLabel': '配偶在港居住？',
                'spouseNo': '否',
                'spouseYes': '是',
                'childrenLabel': '子女人數',
                'overseasLabel': '海外就讀子女人數',
                'newbornLabel': '新生（在一個月內出生）',
                'otherChildrenLabel': '其他子女（除首名）',
                'instructionLabel': '是否被指示離開宿舍？',
                'instructionNo': '否',
                'instructionYes': '是',
                'defectLabel': '宿舍有缺陷？',
                'defectNo': '否',
                'defectYes': '是',
                'calcBtnText': '計算分數',
                'resetBtnText': '重置表單',
                'resultSectionTitle': '計算結果',
                'resultPlaceholderText': '填寫左側表單後點擊「計算分數」',
                'saveBtnText': '儲存目前資料',
                'printBtnText': '列印結果',
                'dataSectionTitle': '已儲存資料',
                'exportBtnText': '匯出所有資料',
                'importBtnText': '匯入資料',
                'noDataTitle': '尚未儲存任何資料',
                'noDataHint': '請使用「儲存目前資料」按鈕保存您的計算結果',
                'statusText': '系統準備就緒，請填寫表單開始計算',
                'backupStatus': '自動備份已啟用',
                'dataStatus': '已儲存',
                'langButton': 'English',
                'fontLabel': '字體',
                'themeLabel': '主題',
                'lightLabel': '亮',
                'darkLabel': '暗',
                'cancelSaveText': '取消儲存',
                'loadText': '載入資料',
                    'disclaimerResult': '此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。',
                    'disclaimerFooter': '此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。',
                    'infoTitle': '使用須知',
                    'scoringLabel': '計分準則（簡述）：',
                    'salaryRule': '薪金分數：薪金 ÷ 除數（預設 538）。',
                    'serviceRule': '年資分數：入職至截止日期的天數 ÷ 365.25 × 年資乘數（預設 6）。',
                    'familyRule': '家庭加分：配偶 +20；每名子女 +10；海外就讀子女 +5；新生 +10；其他子女（除首名）按子女分數並可能有首名加成 +20。',
                    'specialRule': '特殊情況：被指示離開 +72；宿舍有缺陷 +20。',
                    'noticeLabel': '注意事項：',
                    'refOnlyRule': '此計算結果僅供參考，參數或規則可能會改變；請自行核實。',
                    'dateRule': '請確保日期輸入正確（截止日期不可早於入職日期）。',
                    'storageRule': '本工具只在瀏覽器本機儲存資料（localStorage），不會上載伺服器；請自行妥善保管。',
                    'privacyRule': '本工具僅在瀏覽器本機處理及儲存資料；資料不會傳送到任何伺服器或第三方。',
                    'liabilityRule': '任何因使用本工具而引致的後果或損失，本工具不承擔責任。',
                    'closeModalText': '我明白'
            },
            'en': {
                'appTitle': 'Dormitory Score Calculator',
                'inputSectionTitle': 'Input Data',
                'salaryLabel': 'Salary (HKD)',
                'salaryPlaceholder': 'e.g. 30000',
                'requiredLegend': 'indicates required fields',
                'divisorLabel': 'Divisor',
                'divisorHint': 'Default value is 538, please refer to the latest dormitory manual',
                'hireDateLabel': 'Hire Date',
                'endDateLabel': 'End Date',
                'spouseLabel': 'Spouse in Hong Kong?',
                'spouseNo': 'No',
                'spouseYes': 'Yes',
                'childrenLabel': 'Number of Children',
                'overseasLabel': 'Children Studying Overseas',
                'newbornLabel': 'Newborn (within one month)',
                'otherChildrenLabel': 'Other Children (except first child)',
                'instructionLabel': 'Instructed to leave dormitory?',
                'instructionNo': 'No',
                'instructionYes': 'Yes',
                'defectLabel': 'Dormitory has defects?',
                'defectNo': 'No',
                'defectYes': 'Yes',
                'calcBtnText': 'Calculate Score',
                'resetBtnText': 'Reset Form',
                'resultSectionTitle': 'Calculation Result',
                'resultPlaceholderText': 'Fill in the form and click "Calculate Score"',
                'saveBtnText': 'Save Current Data',
                'printBtnText': 'Print Result',
                'dataSectionTitle': 'Saved Data',
                'exportBtnText': 'Export All Data',
                'importBtnText': 'Import Data',
                'noDataTitle': 'No Data Saved',
                'noDataHint': 'Please use "Save Current Data" button to save your calculation',
                'statusText': 'System ready, please fill in the form to start calculation',
                'backupStatus': 'Auto Backup Enabled',
                'dataStatus': 'Saved',
                'langButton': '中文',
                'fontLabel': 'Font',
                'themeLabel': 'Theme',
                'lightLabel': 'Light',
                'darkLabel': 'Dark',
                'cancelSaveText': 'Cancel Save',
                'loadText': 'Load Data',
                    'disclaimerResult': 'Disclaimer: This calculation result is for reference only; accuracy is not guaranteed; this tool is not responsible for any consequences of use.',
                    'disclaimerFooter': 'Disclaimer: This calculation result is for reference only; accuracy is not guaranteed; this tool is not responsible for any consequences of use.',
                    'infoTitle': 'Usage Guide',
                    'scoringLabel': 'Scoring rules (brief):',
                    'salaryRule': 'Salary score: salary ÷ divisor (default 538).',
                    'serviceRule': 'Service score: days from hire to end ÷ 365.25 × multiplier (default 6).',
                    'familyRule': 'Family points: spouse +20; each child +10; child studying overseas +5; newborn +10; other children (except first) per child score, with possible first-child bonus +20.',
                    'specialRule': 'Special cases: instructed to leave +72; dormitory defects +20.',
                    'noticeLabel': 'Notes:',
                    'refOnlyRule': 'The calculation result is for reference only; parameters or rules may change—please verify.',
                    'dateRule': 'Ensure dates are correct (end date cannot be earlier than hire date).',
                    'storageRule': 'This tool only stores data locally in your browser (localStorage); nothing is uploaded—please keep your data safe.',
                    'privacyRule': 'This tool processes and stores your data locally in your browser; no data is transmitted to any server or third party.',
                    'liabilityRule': 'This tool is not responsible for any consequences or losses arising from use.',
                    'closeModalText': 'Got it'
            }
        };
        
        // 切換語言函數
        function setLanguage(lang) {
            // 替整根節點語言屬性，供 CSS 精準控制
            try { document.documentElement.setAttribute('data-lang', lang); } catch(e){}
            const h1El = document.querySelector('header h1');
            currentLang = lang;
            // 英文允許標題換行；中文保持單行（先設置，稍後 fitTitle 再調字級）
            if (h1El) {
                h1El.style.setProperty('white-space', lang === 'en' ? 'normal' : 'nowrap', 'important');
            }
            // 更新所有帶有ID的元素
            Object.keys(translations[lang]).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = translations[lang][key];
                }
            });

            // 【新增】更新 placeholder 屬性
            const salaryInput = document.getElementById('salary');
            if (salaryInput && translations[lang]['salaryPlaceholder']) {
                salaryInput.placeholder = translations[lang]['salaryPlaceholder'];
            }

            // 【修正】更新所有 lang-zh 和 lang-en 的元素顯示狀態
            document.querySelectorAll('.lang-zh').forEach(el => {
                el.style.display = lang === 'zh' ? '' : 'none';
            });
            document.querySelectorAll('.lang-en').forEach(el => {
                el.style.display = lang === 'en' ? '' : 'none';
            });
            
            // 更新語言按鈕文本 - 修正邏輯：顯示相反的語言名稱
            document.getElementById('languageToggle').textContent = 
                lang === 'zh' ? 'EN' : '中';
            // 同步更新狀態列切換按鈕文字
            updateStatusToggleLabel();
            
            // 更新數據狀態文本
            updateDataCount();
            
            // 另外強制更新下拉選單的 Yes/No 顯示，避免部分瀏覽器不渲染 option 內部 span
            const yesNoMap = [
                { sel: '#spouse', no: 'spouseNo', yes: 'spouseYes' },
                { sel: '#instruction', no: 'instructionNo', yes: 'instructionYes' },
                { sel: '#defect', no: 'defectNo', yes: 'defectYes' },
            ];
            yesNoMap.forEach(m => {
                const selectEl = document.querySelector(m.sel);
                if (!selectEl) return;
                const noOpt = selectEl.querySelector('option[value="no"]');
                const yesOpt = selectEl.querySelector('option[value="yes"]');
                if (noOpt) noOpt.textContent = translations[lang][m.no];
                if (yesOpt) yesOpt.textContent = translations[lang][m.yes];
            });

            // 重新適配標題字級
            if (typeof fitTitle === 'function') fitTitle();
            // 調整標題以適配當前語言字長
            fitTitle();
        }
        
        // 語言切換事件
        document.getElementById('languageToggle').addEventListener('click', function() {
            const newLang = currentLang === 'zh' ? 'en' : 'zh';
            setLanguage(newLang);
        });
        
        // 計算規則
        const scoringRules = {
            spouse: 20,
            child: 10,
            overseasChild: 5,
            newborn: 10,
            firstChildBonus: 20,
            instruction: 72,
            defect: 20,
            serviceMultiplier: 6
        };
        
        // 當前計算結果
        let currentScore = 0;
        
        // 初始化表單數據
        function initForm() {
            const today = new Date();
            document.getElementById('endDate').valueAsDate = today;
            
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 2);
            document.getElementById('hireDate').valueAsDate = oneYearAgo;
            
            // 完全清空與重置預設值（避免殘留）
            const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
            setVal('salary', '');            // 清空薪金
            setVal('divisor', '538');       // 回復預設除數
            setVal('spouse', 'no');
            setVal('children', '0');
            setVal('overseas', '0');
            setVal('newborn', '0');
            setVal('otherChildren', '0');
            setVal('instruction', 'no');
            setVal('defect', 'no');
            
            // 收起載入／刪除下拉（如果有打開）
            const loadSelect = document.getElementById('loadSelect');
            const deleteSelect = document.getElementById('deleteSelect');
            if (loadSelect) loadSelect.style.display = 'none';
            if (deleteSelect) deleteSelect.style.display = 'none';
            
            // 重置結果區域
            document.querySelector('.result-container').innerHTML = `
                <div class="result-placeholder" id="resultPlaceholder">
                    <i class="fas fa-file-alt"></i>
                    <p><span id="resultPlaceholderText">${translations[currentLang]['resultPlaceholderText']}</span></p>
                </div>
            `;
            
            // 重置當前分數
            currentScore = 0;
            
            updateStatus(translations[currentLang]['statusText']);
            
            // 重置錯誤狀態
            document.querySelectorAll('.input-control').forEach(input => {
                input.classList.remove('error');
            });
        }
        
        // 更新狀態欄
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        // 平滑捲動到指定元素（正常速度 ~500ms），避免定位混亂
        function scrollToElement(el, duration = 1400, offset = -80) {
            if (!el) return;
            const startY = window.pageYOffset;
            const rect = el.getBoundingClientRect();
            // 目標位置：元素頂部再向上預留少少空間（offset）
            const targetY = rect.top + window.pageYOffset + offset;
            const diff = targetY - startY;
            let startTime = null;
            function easeInOutQuad(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }
            function step(ts) {
                if (!startTime) startTime = ts;
                const progress = Math.min((ts - startTime) / duration, 1);
                const eased = easeInOutQuad(progress);
                window.scrollTo(0, startY + diff * eased);
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // 驗證必填字段
        function validateRequiredFields() {
            const requiredFields = [
                {id: 'salary', name: translations[currentLang]['salaryLabel']},
                {id: 'divisor', name: translations[currentLang]['divisorLabel']},
                {id: 'hireDate', name: translations[currentLang]['hireDateLabel']},
                {id: 'endDate', name: translations[currentLang]['endDateLabel']}
            ];
            
            let isValid = true;
            let missingFields = [];
            let firstMissingEl = null;
            
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = (element && typeof element.value === 'string') ? element.value.trim() : '';
                
                if (!value) {
                    if (element) {
                        element.classList.add('error');
                        element.classList.add('glow-yellow'); // 未填：黃色光暈
                        element.classList.remove('glow-red');
                        if (!firstMissingEl) firstMissingEl = element; // 記錄第一個未填欄位
                    }
                    missingFields.push(field.name);
                    isValid = false;
                } else if (element) {
                    element.classList.remove('error');
                    element.classList.remove('glow-yellow');
                    element.classList.remove('glow-red');
                }
            });
            
            if (!isValid) {
                const errorMsg = currentLang === 'zh' ? 
                    `錯誤：請填寫必填欄位 - ${missingFields.join('、')}` :
                    `Error: Please fill in required fields - ${missingFields.join(', ')}`;
                updateStatus(errorMsg);
                // 自動引導：聚焦、滾動到視窗中間、視覺提示
                if (firstMissingEl) {
                    try { firstMissingEl.focus(); } catch(e) {}
                    // 用自訂動畫（約 500ms），速度正常而唔會太慢；預留 80px 空間
                    scrollToElement(firstMissingEl, 800, -80);
                    firstMissingEl.classList.add('shake');
                    setTimeout(() => firstMissingEl.classList.remove('shake'), 700);
                }
            }
            
            return isValid;
        }
        
        // 計算分數
        function calculateScore() {
            // 驗證必填字段
            if (!validateRequiredFields()) {
                return;
            }
            const logicRes = validateLogic();
            if (!logicRes.valid) {
                updateStatus(logicRes.msg);
                if (logicRes.el) { shakeInput(logicRes.el); try { logicRes.el.focus(); } catch(e){} }
                return;
            }

            
            // 獲取表單值
            const salaryRaw = (document.getElementById('salary').value || '').trim();
            if (!/^\d+(?:\.\d+)?$/.test(salaryRaw)) {
                const msg = currentLang === 'zh' ? '錯誤：薪金只允許數字及單一小數點' : 'Error: Salary allows only digits and a single decimal point';
                updateStatus(msg);
                const el = document.getElementById('salary');
                if (el) { el.classList.add('error','glow-red'); shakeInput(el); try { el.focus(); } catch(e){} }
                return;
            }
            const salary = parseFloat(salaryRaw);
            const divisorRaw = (document.getElementById('divisor').value || '').trim();
            if (!/^\d+(?:\.\d+)?$/.test(divisorRaw)) {
                const msg = currentLang === 'zh' ? '錯誤：除數只允許數字及單一小數點' : 'Error: Divisor allows only digits and a single decimal point';
                updateStatus(msg);
                const el = document.getElementById('divisor');
                if (el) { el.classList.add('error','glow-red'); shakeInput(el); try { el.focus(); } catch(e){} }
                return;
            }
            const divisor = parseFloat(divisorRaw);
            const hireDate = document.getElementById('hireDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Date fix: parse explicitly
            const hireParts = hireDate.split('-');
            const hire = new Date(hireParts[0], hireParts[1]-1, hireParts[2]);
            const endParts = endDate.split('-');
            const end = new Date(endParts[0], endParts[1]-1, endParts[2]);
            
            // 額外邏輯檢查：海外子女不可大於子女人數
            const childrenValCalc = parseInt(document.getElementById('children').value) || 0;
            const overseasValCalc = parseInt(document.getElementById('overseas').value) || 0;
            if (overseasValCalc > childrenValCalc) {
                const overMsg = currentLang === 'zh' ? '錯誤：海外子女不可多於子女人數' : 'Error: Overseas children cannot exceed total children';
                updateStatus(overMsg);
                const overseasEl2 = document.getElementById('overseas');
                if (overseasEl2) overseasEl2.classList.add('error','glow-red');
                scrollToElement(overseasEl2, 900, -80);
                return;
            }

            if (end < hire) {
                const errorMsg = currentLang === 'zh' ? 
                    "錯誤：截止日期不能早於入職日期" : 
                    "Error: End date cannot be earlier than hire date";
                updateStatus(errorMsg);
                const endEl = document.getElementById('endDate');
    const childrenEl = document.getElementById('children');
    const overseasEl = document.getElementById('overseas');
    const newbornEl = document.getElementById('newborn');
    const otherChildrenEl = document.getElementById('otherChildren');
                const hireEl = document.getElementById('hireDate');
                if (endEl) { endEl.classList.add('error'); endEl.classList.add('glow-red'); }
                if (hireEl) { hireEl.classList.add('error'); hireEl.classList.add('glow-red'); }
                return;
            } else {
                const endEl = document.getElementById('endDate');
                const hireEl = document.getElementById('hireDate');
                if (endEl) { endEl.classList.remove('error'); endEl.classList.remove('glow-red'); }
                if (hireEl) { hireEl.classList.remove('error'); hireEl.classList.remove('glow-red'); }
            }
            
            const spouse = document.getElementById('spouse').value === 'yes';
            const children = parseInt(document.getElementById('children').value) || 0;
            const overseas = parseInt(document.getElementById('overseas').value) || 0;
            const newborn = parseInt(document.getElementById('newborn').value) || 0;
            const otherChildren = parseInt(document.getElementById('otherChildren').value) || 0;
            const instruction = document.getElementById('instruction').value === 'yes';
            const defect = document.getElementById('defect').value === 'yes';
            
            // 計算年資分數 (使用365.25日為一年)
            const oneDay = 1000 * 60 * 60 * 24;
            const days = Math.floor((end - hire) / oneDay) + 1;
            const years = days / 365.25;
            const serviceScore = years * scoringRules.serviceMultiplier;
            
            // 計算薪金分數
            const salaryScore = salary / divisor;
            
            // 家庭相關分數
            const spouseScore = spouse ? scoringRules.spouse : 0;
            const childrenScore = children * scoringRules.child;
            const overseasScore = overseas * scoringRules.overseasChild;
            const newbornScore = newborn * scoringRules.newborn;
            const otherChildrenScore = otherChildren * scoringRules.child + 
                                     (otherChildren > 0 ? scoringRules.firstChildBonus : 0);
            
            // 特殊情況分數
            const instructionScore = instruction ? scoringRules.instruction : 0;
            const defectScore = defect ? scoringRules.defect : 0;
            
            // 總分
            currentScore = salaryScore + serviceScore + spouseScore + childrenScore + 
                          overseasScore + newbornScore + otherChildrenScore + 
                          instructionScore + defectScore;
            
            // 顯示結果
            displayResult(currentScore, {
                salaryScore, serviceScore, spouseScore, childrenScore, 
                overseasScore, newbornScore, otherChildrenScore, 
                instructionScore, defectScore,
                salary, divisor, days, years
            });
            
            const successMsg = currentLang === 'zh' ? 
                `計算完成！總分: ${currentScore.toFixed(2)}` : 
                `Calculation completed! Total score: ${currentScore.toFixed(2)}`;
            updateStatus(successMsg);
            
            // 計算完成後，自動滾動到結果區域
            const resultSection = document.querySelector('.result-section');
            if (resultSection) {
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            // 套用目前 UI 設定到結果區（避免字體大小或主題未生效）
            const ui = getUiSettings();
            applyUiSettings(ui);
            }
        }
        
        // 顯示結果
        function displayResult(totalScore, details) {
            const resultContainer = document.querySelector('.result-container');
            
            // 根據語言顯示結果
            if (currentLang === 'zh') {
                resultContainer.innerHTML = `
                    <div class="highlight-score">總分: ${totalScore.toFixed(4)}</div>
                    
                    <div class="result-details">
                        <div class="result-item">
                            <div class="result-label">薪金分數</div>
                            <div class="result-value">${details.salary} ÷ ${details.divisor} = ${details.salaryScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">年資分數</div>
                            <div class="result-value">${details.days} 天 (${details.years.toFixed(2)} 年) × ${scoringRules.serviceMultiplier} = ${details.serviceScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">家庭分數</div>
                            <div class="result-value">
                                配偶: ${details.spouseScore}分 | 
                                子女: ${details.childrenScore}分 | 
                                海外: ${details.overseasScore}分 | 
                                新生: ${details.newbornScore}分 | 
                                其他: ${details.otherChildrenScore}分
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">特殊分數</div>
                            <div class="result-value">
                                指示離開: ${details.instructionScore}分 | 
                                宿舍缺陷: ${details.defectScore}分
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">詳細分數組成</div>
                            <div class="result-value">
                                薪金分數: ${details.salaryScore.toFixed(4)}<br>
                                年資分數: ${details.serviceScore.toFixed(4)}<br>
                                家庭分數: ${(details.spouseScore + details.childrenScore + details.overseasScore + details.newbornScore + details.otherChildrenScore).toFixed(4)}<br>
                                特殊分數: ${(details.instructionScore + details.defectScore).toFixed(4)}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="highlight-score">Total Score: ${totalScore.toFixed(4)}</div>
                    
                    <div class="result-details">
                        <div class="result-item">
                            <div class="result-label">Salary Score</div>
                            <div class="result-value">${details.salary} ÷ ${details.divisor} = ${details.salaryScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Service Score</div>
                            <div class="result-value">${details.days} days (${details.years.toFixed(2)} years) × ${scoringRules.serviceMultiplier} = ${details.serviceScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Family Score</div>
                            <div class="result-value">
                                Spouse: ${details.spouseScore} | 
                                Children: ${details.childrenScore} | 
                                Overseas: ${details.overseasScore} | 
                                Newborn: ${details.newbornScore} | 
                                Other: ${details.otherChildrenScore}
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Special Score</div>
                            <div class="result-value">
                                Instruction: ${details.instructionScore} | 
                                Defect: ${details.defectScore}
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Score Composition</div>
                            <div class="result-value">
                                Salary Score: ${details.salaryScore.toFixed(4)}<br>
                                Service Score: ${details.serviceScore.toFixed(4)}<br>
                                Family Score: ${(details.spouseScore + details.childrenScore + details.overseasScore + details.newbornScore + details.otherChildrenScore).toFixed(4)}<br>
                                Special Score: ${(details.instructionScore + details.defectScore).toFixed(4)}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // 保存目前資料（命名：YYYYMMDD_HHMMSS_用家標籤）
        function saveCurrentData() {
            const salary = document.getElementById('salary').value;
            const divisor = document.getElementById('divisor').value;
            const hireDate = document.getElementById('hireDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!salary || !divisor || !hireDate || !endDate || currentScore === 0) {
                const errorMsg = currentLang === 'zh' ? 
                    "錯誤：請先填寫必填欄位並計算分數" : 
                    "Error: Please fill in required fields and calculate score";
                updateStatus(errorMsg);
                return;
            }

            document.getElementById('saveNoticeModal').style.display = 'flex';
        }
        
        // 添加數據卡片
        function addDataCard(name, data) {
            const dataContainer = document.querySelector('.data-container');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (noDataMessage) {
                noDataMessage.style.display = 'none';
            }
            
            const card = document.createElement('div');
            card.className = 'data-card';
            // 安全處理：避免把用戶輸入直接注入 HTML
            const safe = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
            const safeName = safe(name);
            const safeTime = safe(data.timestamp || '');
            const safeSalary = safe(data.salary || '0');
            const safeChildren = safe(data.children || '0');
            const safeSpouse = data.spouse === 'yes' ? (currentLang === 'zh' ? '是' : 'Yes') : (currentLang === 'zh' ? '否' : 'No');
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-name">${safeName}</div>
                    <div class="card-date">${safeTime}</div>
                </div>
                <div class="card-score">${safe(data.score || '0')} ${currentLang === 'zh' ? '分' : ''}</div>
                <div class="card-details">
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '薪金' : 'Salary'}</div>
                        <div class="detail-value">HK$ ${safeSalary}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '子女' : 'Children'}</div>
                        <div class="detail-value">${safeChildren} ${currentLang === 'zh' ? '人' : ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '配偶在港' : 'Spouse in HK'}</div>
                        <div class="detail-value">${safe(safeSpouse)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '保存時間' : 'Saved Time'}</div>
                        <div class="detail-value">${safeTime}</div>
                    </div>
                </div>
                <div class="card-actions">
                    <div class="action-btn load-btn" data-name="${safeName}">
                        <i class="fas fa-download"></i> <span>${currentLang === 'zh' ? '載入' : 'Load'}</span>
                    </div>
                    <div class="action-btn delete-btn" data-name="${safeName}">
                        <i class="fas fa-trash"></i> <span>${currentLang === 'zh' ? '刪除' : 'Delete'}</span>
                    </div>
                </div>
            `;
            
            dataContainer.prepend(card);
            
            // 添加事件監聽器
            card.querySelector('.load-btn').addEventListener('click', function() {
                loadSavedData(this.dataset.name);
            });
            
            card.querySelector('.delete-btn').addEventListener('click', function() {
                deleteSavedData(this.dataset.name);
            });
        }
        
        // 加載保存的數據
        function loadSavedData(name) {
            const savedData = JSON.parse(localStorage.getItem('dormData')) || {};
            const data = savedData[name];
            
            if (!data) {
                const errorMsg = currentLang === 'zh' ? 
                    "錯誤：找不到保存的數據" : 
                    "Error: Saved data not found";
                updateStatus(errorMsg);
                return;
            }
            
            // 填充表單
            document.getElementById('salary').value = data.salary;
            document.getElementById('divisor').value = data.divisor;
            document.getElementById('hireDate').value = data.hireDate;
            document.getElementById('endDate').value = data.endDate;
            document.getElementById('spouse').value = data.spouse;
            document.getElementById('children').value = data.children;
            document.getElementById('overseas').value = data.overseas;
            document.getElementById('newborn').value = data.newborn;
            document.getElementById('otherChildren').value = data.otherChildren;
            document.getElementById('instruction').value = data.instruction;
            document.getElementById('defect').value = data.defect;
            
            // 設置當前分數
            currentScore = parseFloat(data.score) || 0;
            
            // 顯示結果
            if (currentScore > 0) {
                calculateScore();
            }
            
            const successMsg = currentLang === 'zh' ? 
                "已載入保存的數據: " + name : 
                "Loaded saved data: " + name;
            updateStatus(successMsg);
        }
        
        // 刪除保存的數據
        function deleteSavedData(name) {
            const confirmMsg = currentLang === 'zh' ? 
                `確定要刪除「${name}」嗎？` : 
                `Are you sure you want to delete "${name}"?`;
                
            if (!confirm(confirmMsg)) return;
            
            const savedData = JSON.parse(localStorage.getItem('dormData')) || {};
            delete savedData[name];
            localStorage.setItem('dormData', JSON.stringify(savedData));
            
            // 從UI中移除卡片
            document.querySelectorAll('.data-card').forEach(card => {
                if (card.querySelector('.load-btn').dataset.name === name) {
                    card.remove();
                }
            });
            
            const successMsg = currentLang === 'zh' ? 
                "已刪除保存的數據: " + name : 
                "Deleted saved data: " + name;
            updateStatus(successMsg);
            
            // 更新數據計數
            updateDataCount();
            
            // 檢查是否還有數據
            if (Object.keys(savedData).length === 0) {
                const nd = document.getElementById('noDataMessage');
                if (nd) nd.style.display = 'block';
            }
        }
        
        // 導出所有數據
        function exportAllData() {
            const savedData = localStorage.getItem('dormData') || '{}';
            const blob = new Blob([savedData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const pad = n => String(n).padStart(2, '0');
            const now = new Date();
            // 匯出檔名時間（不含秒）：YYYY-MM-DD_HHMM
            const dateStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = `dormitory_data_backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
            
            const successMsg = currentLang === 'zh' ? 
                "已導出所有數據" : 
                "All data exported";
            updateStatus(successMsg);
        }
        
        // 導入數據
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // 驗證數據格式
                        if (typeof data !== 'object') {
                            throw new Error('無效的數據格式');
                        }
                        
                        // 保存到本地存儲
                        localStorage.setItem('dormData', JSON.stringify(data));
                        
                        // 更新UI
                        document.querySelector('.data-container').innerHTML = '';
                        document.getElementById('noDataMessage').style.display = 'none';
                        
                        for (const [name, item] of Object.entries(data)) {
                            addDataCard(name, item);
                        }
                        
                        const successMsg = currentLang === 'zh' ? 
                            `已導入數據: ${Object.keys(data).length} 筆記錄` : 
                            `Data imported: ${Object.keys(data).length} records`;
                        updateStatus(successMsg);
                        updateDataCount();
                    } catch (error) {
                        const errorMsg = currentLang === 'zh' ? 
                            `錯誤: ${error.message}` : 
                            `Error: ${error.message}`;
                        updateStatus(errorMsg);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // 更新數據計數（修正：保留並重建 #dataCount 內嵌結構，避免被覆蓋）
        function updateDataCount() {
            const savedDataRaw = localStorage.getItem('dormData');
            let savedData = {};
            try {
                savedData = savedDataRaw ? JSON.parse(savedDataRaw) : {};
            } catch (e) {
                // 若資料損壞，重設為空物件
                savedData = {};
            }
            const count = Object.keys(savedData).length;
            const dataStatusEl = document.getElementById('dataStatus');
            if (!dataStatusEl) return;
            
            // 依語言重建內容，確保 #dataCount 仍然存在於 DOM 中
            if (currentLang === 'zh') {
                dataStatusEl.innerHTML = `已儲存 <span id="dataCount">${count}</span> 筆資料`;
            } else {
                dataStatusEl.innerHTML = `<span id="dataCount">${count}</span> records saved`;
            }
        }
        
        // 加載保存的數據
        function loadAllSavedData() {
            const savedData = JSON.parse(localStorage.getItem('dormData')) || {};
            
            if (Object.keys(savedData).length === 0) {
                const nd = document.getElementById('noDataMessage');
                if (nd) nd.style.display = 'block';
                return;
            }
            
            const nd2 = document.getElementById('noDataMessage');
            if (nd2) nd2.style.display = 'none';
            
            for (const [name, data] of Object.entries(savedData)) {
                addDataCard(name, data);
            }
            
            updateDataCount();
        }
        
        // 顯示調校：字體大小與主題（亮／暗）
        // 字體縮放：只調整「內容」的文字（表單與結果區），不影響大標題與工具列
        let __baselineSizes = null;
        function captureBaselineSizes() {
            const selectors = [
                '.form-section label',
                '.form-section .input-control',
                '.result-section .highlight-score',
                '.result-section .result-container',
                '.result-section .result-item',
                '.result-section .result-label',
                '.result-section .result-value'
            ];
            __baselineSizes = {};
            selectors.forEach(sel => {
                document.querySelectorAll(sel).forEach((el, idx) => {
                    const key = sel+':'+idx;
                    const size = parseFloat(getComputedStyle(el).fontSize) || 16;
                    __baselineSizes[key] = {el, size};
                });
            });
        }
        function applyFontScale(scale) {
            if (!__baselineSizes) captureBaselineSizes();
            Object.values(__baselineSizes).forEach(({el,size}) => {
                const px = (size * scale) + 'px';
                // 使用 !important 以覆蓋樣式表中的 !important 規則（例如 h1）
                el.style.setProperty('font-size', px, 'important');
            });
        }
        function applyUiSettings(settings) {
            if (settings.fontScale) {
                applyFontScale(settings.fontScale);
            }
            const theme = settings.theme === 'light' ? 'theme-light' : 'theme-dark';
            document.documentElement.classList.remove('theme-light','theme-dark');
            document.documentElement.classList.add(theme);
            document.body.style.background = `linear-gradient(135deg, var(--primary), var(--primary-dark))`;
            document.body.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-light') || '#fff';
        }
        
        function getUiSettings() {
            try { return JSON.parse(localStorage.getItem('uiSettings')) || {}; } catch(e) { return {}; }
        }
        
        function setUiSettings(next) {
            localStorage.setItem('uiSettings', JSON.stringify(next));
            applyUiSettings(next);
        }
        
        function initUiControls() {
            const settings = getUiSettings();
            if (!settings.fontScale) settings.fontScale = 1.0; // 比例 0.8–1.6
            if (!settings.theme) settings.theme = 'dark'; // 第一次載入預設黑暗，之後記憶使用者選擇
            applyUiSettings(settings);
            const inc = document.getElementById('fontInc');
            const dec = document.getElementById('fontDec');
            const themeBtn = document.getElementById('themeToggle');
            
            if (inc) inc.addEventListener('click', () => {
                settings.fontScale = Math.min(settings.fontScale + 0.1, 1.6);
                setUiSettings(settings);
            });
            if (dec) dec.addEventListener('click', () => {
                settings.fontScale = Math.max(settings.fontScale - 0.1, 0.8);
                setUiSettings(settings);
            });
            if (themeBtn) themeBtn.addEventListener('click', () => { settings.theme = settings.theme === 'light' ? 'dark' : 'light'; setUiSettings(settings); });
            
        }
        
        // 事件監聽
        document.getElementById('calcBtn').addEventListener('click', calculateScore);
        (function(){
  const resetBtn = document.getElementById('resetBtn');
  if (!resetBtn) return;
  let mini = document.getElementById('resetConfirmMini');
  if (!mini){
    mini = document.createElement('div');
    mini.id = 'resetConfirmMini';
    mini.className = 'mini-confirm';
    mini.innerHTML = '<div class="mini-lines"><span id="miniMsg1">確定重置？</span></div><div class="mini-actions"><button class="mini-btn cancel" type="button">取消</button><button class="mini-btn ok" type="button">確定</button></div>';
    document.body.appendChild(mini);
  }
  function showMini(){
    const r = resetBtn.getBoundingClientRect();
    // 置於按鈕右上，避免遮住主要按鈕
    // 目標寬度：跟主要輸入欄一致（若找不到則用 resetBtn 所在容器寬度）
    const inputEl = document.querySelector('.form-section .input-control') || document.querySelector('.input-control');
    const containerEl = document.querySelector('.form-section') || resetBtn.closest('.form-section') || document.body;
    const inputBox = inputEl ? inputEl.getBoundingClientRect() : resetBtn.getBoundingClientRect();
    const containerBox = containerEl.getBoundingClientRect();
    const targetWidth = Math.min(inputBox.width, window.innerWidth - 24); // 留邊距
    mini.style.width = Math.round(targetWidth) + 'px';
    // 置中：以容器中心計算
    const left = containerBox.left + (containerBox.width - targetWidth)/2;
    mini.style.left = Math.round(Math.max(12, Math.min(left, window.innerWidth - targetWidth - 12))) + 'px';
    // 放在 reset 按鈕上方一點
    mini.style.top = Math.round(Math.max(r.top - 12 - 64, 10)) + 'px';
    mini.style.display = 'block';
    const zh = (document.documentElement.getAttribute('data-lang') || 'zh') === 'zh';
    document.getElementById('miniMsg1').textContent = zh ? '確定重置？' : 'Reset?';
    mini.querySelector('.cancel').textContent = zh ? '取消' : 'Cancel';
    mini.querySelector('.ok').textContent = zh ? '確定' : 'OK';
  }
  mini.addEventListener('click', (ev)=>{
    const t = ev.target;
    if (t.classList.contains('cancel')){ mini.style.display='none'; }
    if (t.classList.contains('ok')){ mini.style.display='none'; initForm(); }
  });
  resetBtn.addEventListener('click', (e)=>{ e.preventDefault(); showMini(); });
})();
        document.getElementById('saveDataBtn').addEventListener('click', saveCurrentData);
// 語言圓形按鈕文字自適應，避免出界
(function(){
  const langBtn = document.getElementById('langToggle');
  function fitLangBtn(){
    if(!langBtn) return;
    langBtn.style.fontSize='0.78rem';
    const max=0.78, min=0.52;
    let cur=max;
    // 建立隱形測量器
    const meas=document.createElement('span');
    meas.style.position='absolute';
    meas.style.visibility='hidden';
    meas.style.whiteSpace='nowrap';
    meas.style.fontWeight='700';
    document.body.appendChild(meas);
    meas.textContent=(langBtn.textContent||'').trim();
    const limit = langBtn.clientWidth*0.86; // 文字寬度上限
    while(cur>=min){
      meas.style.fontSize=cur+'rem';
      if(meas.getBoundingClientRect().width<=limit) break;
      cur-=0.02;
    }
    langBtn.style.fontSize=cur+'rem';
    document.body.removeChild(meas);
  }
  fitLangBtn();
  window.addEventListener('resize', fitLangBtn);
  const obs = new MutationObserver(fitLangBtn);
  if(langBtn) obs.observe(langBtn, {childList:true, characterData:true, subtree:true});
})();
        const loadBtnEl = document.getElementById('loadBtn');
        const loadSelectEl = document.getElementById('loadSelect');
        if (loadBtnEl && loadSelectEl) {
            loadBtnEl.addEventListener('click', showLoadSelect);
            loadSelectEl.addEventListener('change', function() {
                const name = this.value;
                if (name) loadSavedData(name);
                // 選擇後收起下拉
                this.style.display = 'none';
            });
        }
        const cancelSaveBtn = document.getElementById('cancelSaveBtn');
        const deleteSelectEl = document.getElementById('deleteSelect');
        if (cancelSaveBtn && deleteSelectEl) {
            cancelSaveBtn.addEventListener('click', showDeleteSelect);
            deleteSelectEl.addEventListener('change', function() {
                const name = this.value;
                if (!name) { this.style.display = 'none'; return; }
                if (name === '__DELETE_ALL__') {
                    deleteAllSavedData();
                } else {
                    deleteSavedData(name);
                }
                this.style.display = 'none';
            });
        }
        
        // 顯示載入選單並填入所有儲存的檔名（依建立時間新到舊）
        function showLoadSelect() {
            let savedData = {};
            try { savedData = JSON.parse(localStorage.getItem('dormData')) || {}; } catch(e) { savedData = {}; }
            const keys = Object.keys(savedData);
            if (keys.length === 0) {
                const msg = currentLang === 'zh' ? "沒有可載入的資料" : "No data to load";
                updateStatus(msg);
                return;
            }
            // 排序：按 createdAt 降序（新到舊）；沒有 createdAt 的放最後
            keys.sort((a,b) => (savedData[b].createdAt||0) - (savedData[a].createdAt||0));
            const sel = document.getElementById('loadSelect');
            sel.innerHTML = '';
            // 先加一個提示選項
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = currentLang === 'zh' ? '選擇要載入的檔名…' : 'Select a record to load…';
            sel.appendChild(placeholder);
            for (const k of keys) {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                sel.appendChild(opt);
            }
            sel.style.display = 'inline-block';
            sel.focus();
        }
        
        // 顯示刪除選單（包含「刪除全部」及所有檔名）
        function showDeleteSelect() {
            let savedData = {};
            try { savedData = JSON.parse(localStorage.getItem('dormData')) || {}; } catch(e) { savedData = {}; }
            const keys = Object.keys(savedData);
            if (keys.length === 0) {
                const msg = currentLang === 'zh' ? '目前沒有可刪除的資料' : 'No saved record to delete';
                updateStatus(msg);
                return;
            }
            // 排序（新到舊）
            keys.sort((a,b) => (savedData[b].createdAt||0) - (savedData[a].createdAt||0));
            const sel = document.getElementById('deleteSelect');
            sel.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = currentLang === 'zh' ? '選擇要刪除的檔名…' : 'Select a record to delete…';
            sel.appendChild(placeholder);
            const deleteAll = document.createElement('option');
            deleteAll.value = '__DELETE_ALL__';
            deleteAll.textContent = currentLang === 'zh' ? '刪除全部（Danger）' : 'Delete ALL (Danger)';
            sel.appendChild(deleteAll);
            for (const k of keys) {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                sel.appendChild(opt);
            }
            sel.style.display = 'inline-block';
            sel.focus();
        }
        
        // 刪除全部儲存資料
        function deleteAllSavedData() {
            if (!confirm(currentLang === 'zh' ? '確定要刪除全部儲存資料嗎？此操作不可恢復。' : 'Delete ALL saved records? This action cannot be undone.')) return;
            localStorage.removeItem('dormData');
            document.querySelector('.data-container')?.replaceChildren();
            const nd = document.getElementById('noDataMessage');
            if (nd) nd.style.display = 'block';
            updateDataCount();
            const msg = currentLang === 'zh' ? '已刪除全部儲存資料' : 'All saved records deleted';
            updateStatus(msg);
        }
        
        // 標題自適應：根據容器寬度自動縮放，保證單行完整顯示
        let __fitTitleRaf = null;
        function fitTitle() {
            if (__fitTitleRaf) cancelAnimationFrame(__fitTitleRaf);
            __fitTitleRaf = requestAnimationFrame(() => {
                const header = document.querySelector('header');
                const h1 = header ? header.querySelector('h1') : null;
                if (!h1 || !header) return;
                const maxPx = 32; // 大屏最高
                const minPx = 16; // 小屏最低
                let size = maxPx;
                h1.style.setProperty('font-size', size + 'px', 'important');
                const isEn = (typeof currentLang !== 'undefined') && currentLang === 'en';
                h1.style.setProperty('white-space', isEn ? 'normal' : 'nowrap', 'important');
                const available = header.clientWidth - 24; // 預留左右邊距
                let steps = 0;
                while (h1.scrollWidth > available && size > minPx && steps < 24) {
                    size -= 1;
                    h1.style.setProperty('font-size', size + 'px', 'important');
                    steps++;
                }
            });
        }
        // 視窗改變時重新適配（防抖）
        let __fitTitleTimer = null;
        window.addEventListener('resize', () => {
            clearTimeout(__fitTitleTimer);
            __fitTitleTimer = setTimeout(fitTitle, 120);
        });
        
        // 即時（Live）驗證：在輸入時就提示
function validateLiveFields() {
    // 必填：薪金、除數、入職、截止
    const salaryEl = document.getElementById('salary');
    const divisorEl = document.getElementById('divisor');
    const hireEl = document.getElementById('hireDate');
    const endEl = document.getElementById('endDate');
    const childrenEl = document.getElementById('children');
    const overseasEl = document.getElementById('overseas');
    const newbornEl = document.getElementById('newborn');
    const otherChildrenEl = document.getElementById('otherChildren');

    const salary = parseFloat((salaryEl && salaryEl.value) || '');
    const divisor = parseFloat((divisorEl && divisorEl.value) || '');
    const hire = new Date((hireEl && hireEl.value) || '');
    const end = new Date((endEl && endEl.value) || '');
    const childrenVal = parseFloat((childrenEl && childrenEl.value) || '0');
    const overseasVal = parseFloat((overseasEl && overseasEl.value) || '0');
    const newbornVal = parseFloat((newbornEl && newbornEl.value) || '0');
    const otherChildrenVal = parseFloat((otherChildrenEl && otherChildrenEl.value) || '0');

    // 清理舊狀態
    [salaryEl, divisorEl, hireEl, endEl, childrenEl, overseasEl, newbornEl, otherChildrenEl].forEach(el => { if (el) { el.classList.remove('glow-yellow','glow-red'); el.classList.remove('error'); } });

    // 空白提示：黃色光
    [{el: salaryEl},{el: divisorEl},{el: hireEl},{el: endEl},{el: childrenEl},{el: overseasEl},{el: newbornEl},{el: otherChildrenEl}].forEach(item => {
        if (item.el && item.el.value === '') { item.el.classList.add('glow-yellow'); }
    });

    // 數值基本檢查
    if (salaryEl && !isNaN(salary) && salary < 0) { salaryEl.classList.add('error','glow-red'); }
    if (divisorEl && !isNaN(divisor) && divisor < 1) { divisorEl.classList.add('error','glow-red'); }

    // 非負整數檢查（子女、海外、新生、其他子女）
    function isNonNegativeInteger(n){ return Number.isInteger(n) && n >= 0; }
    if (childrenEl && !isNonNegativeInteger(childrenVal)) { childrenEl.classList.add('error','glow-red'); }
    if (overseasEl && !isNonNegativeInteger(overseasVal)) { overseasEl.classList.add('error','glow-red'); }
    if (newbornEl && !isNonNegativeInteger(newbornVal)) { newbornEl.classList.add('error','glow-red'); }
    if (otherChildrenEl && !isNonNegativeInteger(otherChildrenVal)) { otherChildrenEl.classList.add('error','glow-red'); }

    // 邏輯檢查：海外子女人數不可大於子女人數
    if (childrenEl && overseasEl && isNonNegativeInteger(childrenVal) && isNonNegativeInteger(overseasVal)) {
        if (overseasVal > childrenVal) {
            overseasEl.classList.add('error','glow-red');
            const msg = currentLang === 'zh' ? '錯誤：海外子女不可多於子女人數' : 'Error: Overseas children cannot exceed total children';
            updateStatus(msg);
        }
    }

    // 日期先做基本：都填咗先檢查先後
    if (hire.toString() !== 'Invalid Date' && end.toString() !== 'Invalid Date') {
        if (end < hire) {
            // 即時錯誤提示（跟語言）
            const msg = currentLang === 'zh' ? "錯誤：截止日期不能早於入職日期" : "Error: End date cannot be earlier than hire date";
            updateStatus(msg);
            if (endEl) endEl.classList.add('error','glow-red');
            if (hireEl) hireEl.classList.add('error','glow-red');
        }
    }
}

function attachLiveValidation() {
    const ids = ['salary','divisor','hireDate','endDate'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        ['input','change','blur'].forEach(evt => el.addEventListener(evt, validateLiveFields));
    });
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
            initForm();
            loadAllSavedData();
            setLanguage('zh');
            initUiControls();

// 初始化歡迎視窗（僅首次顯示）
(function initWelcomeOnce(){
  try {
    const FLAG_KEY = 'welcomeShown';
    const shown = localStorage.getItem(FLAG_KEY);
    const overlay = document.getElementById('welcomeOverlay');
    const canvas = document.getElementById('confettiCanvas');
    const ctx = canvas ? canvas.getContext('2d') : null;
    const btnLater = document.getElementById('welcomeLater');
    const btnStart = document.getElementById('welcomeStart');
    if (!overlay || !btnLater || !btnStart) return;

    // 霓彩金銀片／雪花效果
    let particles = [];
    let rafId = null;
    function resizeCanvas(){
      if (!canvas) return;
      const rect = overlay.getBoundingClientRect();
      canvas.width = rect.width; canvas.height = rect.height;
    }
    function makeParticle(){
      const w = canvas.width, h = canvas.height;
      const types = ['circle','rect','triangle'];
      const colors = ['#ffd700','#fff8dc','#e6e6e6','#c0c0c0','#ff69b4']; // 金、奶白、銀、淡銀、粉
      return {
        x: Math.random()*w,
        y: -10 - Math.random()*h*0.3,
        size: 3 + Math.random()*6,
        dx: -0.5 + Math.random()*1,
        dy: 1.2 + Math.random()*2.2,
        rot: Math.random()*Math.PI*2,
        drot: (-0.02 + Math.random()*0.04),
        swing: Math.random()*0.6,
        type: types[(Math.random()*types.length)|0],
        color: colors[(Math.random()*colors.length)|0],
        twinkle: Math.random()<0.3
      };
    }
    function drawParticle(p){
      if (!ctx) return;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      const s = p.size;
      ctx.fillStyle = p.color;
      if (p.twinkle){
        const alpha = 0.7 + 0.3*Math.sin(Date.now()/200 + p.x);
        ctx.globalAlpha = alpha;
      }
      switch(p.type){
        case 'circle':
          ctx.beginPath(); ctx.arc(0,0,s*0.6,0,Math.PI*2); ctx.fill(); break;
        case 'rect':
          ctx.fillRect(-s/2,-s/2,s,s*0.7); break;
        case 'triangle':
          ctx.beginPath(); ctx.moveTo(-s/2,s/2); ctx.lineTo(0,-s/2); ctx.lineTo(s/2,s/2); ctx.closePath(); ctx.fill(); break;
        case 'star':
          drawStar(ctx, s);
          break;
      }
      ctx.restore();
    }
    function step(){
      if (!ctx || !canvas) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach(p=>{
        p.y += p.dy; p.x += p.dx + Math.sin(Date.now()/400 + p.y)*p.swing; p.rot += p.drot;
        drawParticle(p);
      });
      // recycle
      const w = canvas.width, h = canvas.height;
      for (let i=0;i<particles.length;i++){
        const p = particles[i];
        if (p.y > h + 20){ particles[i] = makeParticle(); particles[i].y = -10; }
        if (p.x < -20 || p.x > w+20){ particles[i].x = Math.random()*w; }
      }
      rafId = requestAnimationFrame(step);
    }
    function drawStar(ctx, r){
      ctx.beginPath();
      for (let i=0;i<10;i++){
        const angle = i * Math.PI/5;
        const rad = (i%2===0? r : r*0.45);
        ctx.lineTo(Math.cos(angle)*rad, Math.sin(angle)*rad);
      }
      ctx.closePath(); ctx.fill();
    }
    function startConfetti(){
      if (!canvas) return;
      resizeCanvas();
      particles = new Array(280).fill(0).map(()=>makeParticle());
      const extraColors = ['#87CEFA','#7B68EE','#BA55D3'];
      particles.forEach(p=>{ if (Math.random()<0.25){ p.type='star'; p.color=extraColors[(Math.random()*extraColors.length)|0]; } });
      cancelAnimationFrame(rafId); rafId = requestAnimationFrame(step);
      window.addEventListener('resize', resizeCanvas);
      if (window.__confettiBurstTimer) clearInterval(window.__confettiBurstTimer);
      window.__confettiBurstTimer = setInterval(()=>{
        const w = canvas.width;
        for (let i=0;i<50;i++){
          const p = makeParticle();
          p.x = w*0.5 + (Math.random()-0.5)*w*0.2;
          p.y = -15 - Math.random()*40;
          p.dy += 0.8; p.size += 1.2; p.twinkle = true;
          particles[(Math.random()*particles.length)|0] = p;
        }
      }, 2800);
    }
    function stopConfetti(){
      cancelAnimationFrame(rafId); rafId = null; particles = [];
      if (ctx && canvas) ctx.clearRect(0,0,canvas.width,canvas.height);
      window.removeEventListener('resize', resizeCanvas);
      if (window.__confettiBurstTimer) { clearInterval(window.__confettiBurstTimer); window.__confettiBurstTimer = null; }
    }

    const force = (location.hash === '#welcome');
    const openWelcome = () => {
      overlay.style.display = 'flex';
      overlay.style.opacity = '0';
      overlay.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      startConfetti();
      requestAnimationFrame(() => { overlay.style.opacity = '1'; });
    };
    const closeWelcome = () => {
      // 平滑淡出
      overlay.style.opacity = '1';
      const modalEl = overlay.querySelector('.welcome-modal');
      if (modalEl){ modalEl.style.opacity = '0'; modalEl.style.transform = 'translateY(12px) scale(0.98)'; }
      requestAnimationFrame(() => { overlay.style.opacity = '0'; });
      setTimeout(() => {
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
        localStorage.setItem(FLAG_KEY, '1');
        document.body.style.overflow = '';
        stopConfetti();
        if (welcomeLangTimer) { clearInterval(welcomeLangTimer); welcomeLangTimer = null; }
        if (modalEl){ modalEl.style.opacity = ''; modalEl.style.transform = ''; }
      }, 450);
    };

    openWelcome();

    // 語言自動切換（每約2秒）
    const elTitle = overlay.querySelector('.welcome-text');
    const elBody = overlay.querySelector('.welcome-body');
    const elDisclaimer = overlay.querySelector('.welcome-disclaimer');
    const elBtnLater = document.getElementById('welcomeLater');
    const elBtnStart = document.getElementById('welcomeStart');
    const elLangToggle = document.getElementById('langToggle');

    // 初始化 Cross-fade 結構與樣式（同層重疊過渡）
    function setupCrossFade(el, candidates){
      if (!el) return null;
      const initial = (el.textContent || '').trim();
      // 建立占位幽靈層（保持版位與基線，避免元素脫離 Flex 流）
      const ghost = document.createElement('span');
      ghost.className = 'xfade-ghost';
      const longest = Array.isArray(candidates) && candidates.length
        ? candidates.reduce((a, b) => (a.length >= b.length ? a : b))
        : initial;
      ghost.textContent = longest;
      Object.assign(ghost.style, {
        visibility: 'hidden',
        whiteSpace: 'pre-wrap'
      });

      // 建立兩層重疊 layer（不影響排版流，由幽靈層保留空間）
      const layerA = document.createElement('span');
      const layerB = document.createElement('span');
      [layerA, layerB].forEach(layer => {
        layer.className = 'xfade-layer';
        const baseStyle = {
          position: 'absolute', left: '0', width: '100%',
          transition: 'opacity 360ms ease', opacity: '0', willChange: 'opacity',
          whiteSpace: 'pre-wrap', textAlign: 'center'
        };
        // 對於按鈕，使用 top:50% + translate(-50%) 垂直置中
        if (el.tagName === 'BUTTON') {
          Object.assign(layer.style, baseStyle, { top: '50%', transform: 'translateY(-50%)' });
        } else {
          Object.assign(layer.style, baseStyle, { top: '0' });
        }
      });

      // 容器設定：保持 inline-block（不改變 Flex 對齊）、相對定位以承載重疊層
      el.setAttribute('data-xfade-ready', '1');
      el.style.position = 'relative';
      el.style.display = 'inline-block';
      if (el.tagName === 'BUTTON') {
        el.style.lineHeight = '1';
      }
      el.textContent = '';

      // 插入幽靈層作為版位，重疊層位於其上（不改變外部間距與基線）
      el.appendChild(ghost);
      layerA.textContent = initial;
      layerA.style.opacity = '1';
      el.appendChild(layerA);
      el.appendChild(layerB);

      el.dataset.xfadeActive = 'A';
      return { layerA, layerB, ghost };
    }

    const WELCOME_LANGS = [
      {
        title: '歡迎！',
        body: '祝您使用愉快。',
        disclaimer: '此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。',
        later: '稍後再看',
        start: '開始使用'
      },
      {
        title: 'Welcome!',
        body: 'Enjoy your experience.',
        disclaimer: 'Results are for reference only; accuracy is not guaranteed; this tool is not responsible for any consequences of use.',
        later: 'Later',
        start: 'Get Started'
      }
    ];

    // 以所有候選文字建立 Cross-fade（幽靈層確保位置不變）
    const titleXF = setupCrossFade(elTitle, [WELCOME_LANGS[0].title, WELCOME_LANGS[1].title]);
    const bodyXF = setupCrossFade(elBody, [WELCOME_LANGS[0].body, WELCOME_LANGS[1].body]);
    const disclaimerXF = setupCrossFade(elDisclaimer, [WELCOME_LANGS[0].disclaimer, WELCOME_LANGS[1].disclaimer]);
    const laterXF = setupCrossFade(elBtnLater, [WELCOME_LANGS[0].later, WELCOME_LANGS[1].later]);
    const startXF = setupCrossFade(elBtnStart, [WELCOME_LANGS[0].start, WELCOME_LANGS[1].start]);

    let welcomeLangIndex = 0;
    let welcomeLangTimer = null;

    function crossFadeSwap(el, xf, nextText){
      if (!el || !xf) return;
      const active = el.dataset.xfadeActive === 'A' ? xf.layerA : xf.layerB;
      const idle   = el.dataset.xfadeActive === 'A' ? xf.layerB : xf.layerA;
      // 預載下一段文字於閒置層，先置透明
      idle.textContent = nextText;
      idle.style.opacity = '0';
      // 交叉淡入淡出
      requestAnimationFrame(() => {
        active.style.opacity = '0';
        idle.style.opacity = '1';
        // 完成後交換層狀態
        setTimeout(() => {
          el.dataset.xfadeActive = (el.dataset.xfadeActive === 'A') ? 'B' : 'A';
          ensureWelcomeFits();
        }, 380);
      });
    }

    function applyWelcomeLang(i){
      const L = WELCOME_LANGS[i];
      // 依語言設定置中與字級
      overlay.setAttribute('data-lang', i === 1 ? 'en' : 'zh');
      // Cross-fade 內容
      crossFadeSwap(elTitle, titleXF, L.title);
      crossFadeSwap(elBody, bodyXF, L.body);
      crossFadeSwap(elDisclaimer, disclaimerXF, L.disclaimer);
      crossFadeSwap(elBtnLater, laterXF, L.later);
      crossFadeSwap(elBtnStart, startXF, L.start);
      // 對齊尺寸
      ensureWelcomeFits();
    }

    function ensureWelcomeFits(){
      const modal = overlay.querySelector('.welcome-modal');
      if (!modal) return;
      const maxH = Math.min(window.innerHeight * 0.64, 640); // align with CSS max-height
      // Reset sizing
      modal.style.fontSize = '100%';
      const emojis = overlay.querySelectorAll('.welcome-title .emoji');
      emojis.forEach(e => e.style.fontSize = '2.4rem');
      const titleEl = overlay.querySelector('.welcome-title .welcome-text');

      // Downscale globally until fits vertically
      let scale = 1.0;
      const minScale = 0.78; // do not shrink too much
      while (modal.scrollHeight > maxH && scale > minScale){
        scale -= 0.04;
        modal.style.fontSize = `${Math.round(scale*100)}%`;
        emojis.forEach(e => e.style.fontSize = `calc(2.4rem * ${scale})`);
        if (titleEl){
          // Prevent title overflow horizontally
          const titleBox = titleEl.getBoundingClientRect();
          const modalBox = modal.getBoundingClientRect();
          if (titleBox.width > modalBox.width * 0.92){
            const tfs = parseFloat(getComputedStyle(titleEl).fontSize);
            titleEl.style.fontSize = `${Math.max(tfs * 0.9, 18)}px`;
          }
        }
      }

      // If still overflowing, allow modal to scroll within max height
      // Force no internal scrollbar for welcome modal
      modal.style.overflowY = 'hidden';
    }

    function startWelcomeLangCycle(){
      // 停用自動切換，僅套用一次
      if (welcomeLangTimer) { clearInterval(welcomeLangTimer); welcomeLangTimer = null; }
      applyWelcomeLang(welcomeLangIndex);
    }

    // 保持排版在視窗尺寸變更時仍然合適
    window.addEventListener('resize', ensureWelcomeFits);

    // 初始化語言：使用偏好或預設中文
    const pref = localStorage.getItem('welcomeLangPref');
    if (pref === 'en') { welcomeLangIndex = 1; }
    overlay.setAttribute('data-lang', welcomeLangIndex === 1 ? 'en' : 'zh');
    applyWelcomeLang(welcomeLangIndex);

    // 語言切換按鈕事件
    if (elLangToggle){
      elLangToggle.addEventListener('click', () => {
        welcomeLangIndex = (welcomeLangIndex === 1) ? 0 : 1;
        localStorage.setItem('welcomeLangPref', welcomeLangIndex === 1 ? 'en' : 'zh');
        overlay.setAttribute('data-lang', welcomeLangIndex === 1 ? 'en' : 'zh');
        applyWelcomeLang(welcomeLangIndex);
      });
    }

    // 事件綁定
    
    // Old listener removed

    btnStart.addEventListener('click', closeWelcome);
    // click disabled
    // escape disabled

    // 提供測試/手動顯示 API
    window.showWelcomeOverlay = openWelcome;
    window.resetWelcomeFlag = () => localStorage.removeItem(FLAG_KEY);

    // 快捷鍵：Shift + W 顯示歡迎視窗（桌面）
    document.addEventListener('keydown', (e)=>{
      if (e.shiftKey && (e.key === 'W' || e.key === 'w')) {
        openWelcome();
      }
    });

    // 手機：長按主標題 800ms 顯示歡迎視窗
    const appTitle = document.getElementById('appTitle');
    if (appTitle) {
      let pressTimer = null;
      const start = ()=>{ pressTimer = setTimeout(openWelcome, 800); };
      const cancel = ()=>{ if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } };
      appTitle.addEventListener('touchstart', start, {passive:true});
      appTitle.addEventListener('touchend', cancel, {passive:true});
      appTitle.addEventListener('touchmove', cancel, {passive:true});
      appTitle.addEventListener('touchcancel', cancel, {passive:true});
    }
  } catch (e) { /* 忽略錯誤以避免阻塞主流程 */ }
})();

// 手機浮動鍵盤遮擋自動避讓（僅數字鍵盤觸發）
(function initKeyboardAvoidance(){
  const inputs = document.querySelectorAll('input, textarea'); // select 不處理，避免下拉時畫面移動
  let focusedEl = null;
  function isNumeric(el){
    if (!el) return false;
    const t = (el.getAttribute('type')||'').toLowerCase();
    const im = (el.getAttribute('inputmode')||'').toLowerCase();
    const cls = (el.className||'');
    // 以 number / numeric / decimal / tel 視為「數字鍵盤」場景；也容許自訂 class "numeric"
    if (t === 'number') return true;
    if (im === 'numeric' || im === 'decimal' || im === 'tel') return true;
    if (/\bnumeric\b/.test(cls)) return true;
    return false;
  }
  function scrollCenter(el){ try { el.scrollIntoView({behavior:'smooth', block:'center'}); } catch(e){} }
  function applyBottomPadding(){
    const vv = window.visualViewport;
    if (vv && focusedEl && isNumeric(focusedEl)){
      const keyboard = Math.max(0, window.innerHeight - vv.height);
      document.body.style.paddingBottom = keyboard ? (keyboard + 12) + 'px' : '';
    }
  }
  inputs.forEach(el=>{
    el.addEventListener('focus', ()=>{ focusedEl = el; if (isNumeric(el)) { applyBottomPadding(); scrollCenter(el); } });
    el.addEventListener('blur', ()=>{ focusedEl = null; document.body.style.paddingBottom = ''; });
  });
  if (window.visualViewport){
    window.visualViewport.addEventListener('resize', ()=>{ if (focusedEl && isNumeric(focusedEl)) { applyBottomPadding(); scrollCenter(focusedEl); } });
    window.visualViewport.addEventListener('scroll', ()=>{ if (focusedEl && isNumeric(focusedEl)) { applyBottomPadding(); } });
  }
})();
            fitTitle();
            attachLiveValidation();
            validateLiveFields();
            // 綁定「使用須知」彈窗事件
            const infoBtn = document.getElementById('infoBtn');
            const overlay = document.getElementById('infoOverlay');
            const modal = document.getElementById('infoModal');
            const closeBtn = document.getElementById('closeModal');
            const closeX = document.getElementById('closeModalX');
            function openInfo() {
                if (!overlay || !modal) return;
                overlay.style.display = 'block';
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden', 'false');
                overlay.setAttribute('aria-hidden', 'false');
            }
            function closeInfo() {
                if (!overlay || !modal) return;
                overlay.style.display = 'none';
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                overlay.setAttribute('aria-hidden', 'true');
            }
            if (infoBtn) infoBtn.addEventListener('click', openInfo);
            // 事件委派保險：即使按鈕未綁定亦可正常開窗
            document.addEventListener('click', function(e){
                const btn = e.target.closest('#infoBtn');
                if (btn) { e.preventDefault(); openInfo(); }
            });
            if (closeBtn) closeBtn.addEventListener('click', closeInfo);
            if (closeX) closeX.addEventListener('click', closeInfo);
            if (overlay) overlay.addEventListener('click', closeInfo);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeInfo(); });
        });
    

        function proceedSave() {
            document.getElementById('saveNoticeModal').style.display = 'none';

            const salary = document.getElementById('salary').value;
            const divisor = document.getElementById('divisor').value;
            const hireDate = document.getElementById('hireDate').value;
            const endDate = document.getElementById('endDate').value;

            const now = new Date();
            const dateStr = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                String(now.getMinutes()).padStart(2, '0');
            const defaultName = dateStr + '_' + timeStr;

            const recordName = prompt(
                currentLang === 'zh' ? '請輸入記錄名稱(選填)：' : 'Enter record name (optional):',
                defaultName
            );

            if (recordName === null) return;

            const data = {
                name: recordName || defaultName,
                salary: salary,
                divisor: divisor,
                hireDate: hireDate,
                endDate: endDate,
                spouse: document.getElementById('spouse').value,
                children: document.getElementById('children').value,
                overseas: document.getElementById('overseas').value,
                newborn: document.getElementById('newborn').value,
                otherChildren: document.getElementById('otherChildren').value,
                instruction: document.getElementById('instruction').value,
                defect: document.getElementById('defect').value,
                score: currentScore,
                timestamp: now.toLocaleString(currentLang === 'zh' ? 'zh-HK' : 'en-US')
            };

            let savedData = JSON.parse(localStorage.getItem('dormData') || '{}');
            savedData[data.name] = data;
            localStorage.setItem('dormData', JSON.stringify(savedData));

            const msg = currentLang === 'zh' ? 
                '✅ 資料已儲存到您的設備' : 
                '✅ Data saved to your device';
            updateStatus(msg);

            if (typeof loadAllSavedData === 'function') {
                loadAllSavedData();
            }
        }

    
        // Real-time Number Validation
        function validateNumberInput(input) {
            const value = (input.value || '').trim();
            if (value === '') { input.classList.remove('error','glow-red'); return; }
            const isValid = /^\d+(?:\.\d+)?$/.test(value);
            if (!isValid) {
                const msg = currentLang === 'zh' ? '錯誤：只允許數字及單一小數點' : 'Error: Only digits and a single decimal point are allowed';
                updateStatus(msg);
                input.classList.add('error','glow-red');
                shakeInput(input);
            } else {
                input.classList.remove('error','glow-red');
            }
        }

    // === ABSOLUTE CONTROL SANITIZERS (TEXT MODE) ===

    function shakeInput(el) {
        el.classList.remove('shake');
        void el.offsetWidth;
        el.classList.add('shake');
        setTimeout(() => el.classList.remove('shake'), 500);
    }

    // 1. Integer Sanitize (Whitelist 0-9)
    function sanitizeInteger(input) {
        let original = input.value;
        let val = original;

        // Remove ANY char that is not 0-9
        val = val.replace(/[^0-9]/g, '');

        // Remove Leading Zero (01 -> 1)
        if (val.length > 1 && val.startsWith('0')) {
            val = val.replace(/^0+/, '');
        }

        if (val !== original) {
            input.value = val;
            updateStatus(translations[currentLang]['logicErrorInteger']);
            shakeInput(input);
        }
    }

    // 2. Float Sanitize (Whitelist 0-9 and .)
    function sanitizeFloat(input) {
        const value = (input.value || '').trim();
        if (value === '') { input.classList.remove('error','glow-red'); return; }
        const isValid = /^\d+(?:\.\d+)?$/.test(value);
        // Reject any expression like 12+9, 45-9, 1.2.3, etc.
        if (!isValid) {
            const msg = currentLang === 'zh' ? '錯誤：只允許數字及單一小數點' : 'Error: Only digits and a single decimal point are allowed';
            updateStatus(msg);
            input.classList.add('error','glow-red');
            shakeInput(input);
        } else {
            input.classList.remove('error','glow-red');
        }
    }

    // Key Blockers (Backup)
    function blockIntegerKeys(e) {
        if (e.key.length > 1) return; // Allow arrows, backspace
        if (!/[0-9]/.test(e.key)) {
            e.preventDefault();
            updateStatus(translations[currentLang]['logicErrorInteger']);
            shakeInput(e.target);
        }
    }

    function blockFloatKeys(e) {
        if (e.key.length > 1) return; // allow control keys
        const key = e.key;
        const cur = e.target.value || '';
        // Only digits and '.' allowed
        if (!/[0-9.]/.test(key)) {
            e.preventDefault();
            updateStatus(translations[currentLang]['inputSignError']);
            shakeInput(e.target);
            return;
        }
        // Prevent multiple dots
        if (key === '.' && cur.includes('.')) {
            e.preventDefault();
            updateStatus(currentLang === 'zh' ? '錯誤：只允許單一小數點' : 'Error: Only one decimal point is allowed');
            shakeInput(e.target);
        }
    }

    // Logic Validation
    function validateLogic() {
        const getVal = (id) => { const el = document.getElementById(id); const v = el && typeof el.value === 'string' ? el.value.trim() : ''; return v && /^\d+(?:\.\d+)?$/.test(v) ? parseFloat(v) : NaN; };
        const getEl = (id) => document.getElementById(id);

        const sal = getVal('salary');
        if (!isNaN(sal) && sal <= 0) return { valid: false, msg: translations[currentLang]['logicErrorSalary'], el: getEl('salary') };

        const div = getVal('divisor');
        if (!isNaN(div) && div <= 0) return { valid: false, msg: translations[currentLang]['logicErrorDivisor'], el: getEl('divisor') };

        const intIds = ['children', 'overseas', 'newborn', 'otherChildren'];
        for (let id of intIds) {
            const val = getVal(id);
            const el = getEl(id);
            if (el && el.value !== '') {
                if (val < 0 || !Number.isInteger(val)) return { valid: false, msg: translations[currentLang]['logicErrorInteger'], el: el };
            }
        }
        return { valid: true };
    }

</script>
        <div id="infoOverlay" class="modal-overlay" aria-hidden="true"></div>
        <div id="infoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="infoTitle" aria-hidden="true">
            <header>
                <h3 id="infoTitle"><i class="fas fa-info-circle"></i> 使用須知</h3>
                <button id="closeModalX" class="btn btn-warning no-text-shadow btn-small btn-3d" aria-label="關閉"><i class="fas fa-times"></i></button>
            </header>
            <div class="modal-body">
                <p id="scoringLabel" class="label">計分準則（簡述）：</p>
                <ul>
                    <li id="salaryRule">薪金分數：薪金 ÷ 除數（預設 538）。</li>
                    <li id="serviceRule">年資分數：入職至截止日期的天數 ÷ 365.25 × 年資乘數（預設 6）。</li>
                    <li id="familyRule">家庭加分：配偶 +20；每名子女 +10；海外就讀子女 +5；新生 +10；其他子女（除首名）按子女分數並可能有首名加成 +20。</li>
                    <li id="specialRule">特殊情況：被指示離開 +72；宿舍有缺陷 +20。</li>
                </ul>
                <p id="noticeLabel" class="label">注意事項：</p>
                <ul>
                    <li id="refOnlyRule">此計算結果僅供參考，參數或規則可能會改變；請自行核實。</li>
                    <li id="dateRule">請確保日期輸入正確（截止日期不可早於入職日期）。</li>
                    <li id="storageRule">本工具只在瀏覽器本機儲存資料（localStorage），不會上載伺服器；請自行妥善保管。</li>
                    <li id="privacyRule">本工具僅在瀏覽器本機處理及儲存資料；資料不會傳送到任何伺服器或第三方。</li>
                    <li id="liabilityRule">任何因使用本工具而引致的後果或損失，本工具不承擔責任。</li>
                </ul>
            </div>
            <div class="modal-foot">
                <button id="closeModal" class="close-btn btn-3d"><span id="closeModalText">我明白</span></button>
            </div>
        </div>

    <div id="saveNoticeModal" class="modal-overlay" style="display: none;">
        <div class="modal" style="display: block;">
            <header>
                <h3>
                    <i class="fas fa-save"></i> 
                    <span class="lang-zh">儲存確認</span>
                    <span class="lang-en" style="display:none;">Save Confirmation</span>
                </h3>
            </header>
            <div class="modal-body">
                <p style="font-size: 1.05rem; margin-bottom: 12px;">
                    <span class="lang-zh">資料將儲存於您的設備。</span>
                    <span class="lang-en" style="display:none;">Data will be saved on your device.</span>
                </p>
                <p style="font-size: 0.9rem; color: #aaa;">
                    <span class="lang-zh">（不會上傳伺服器，請自行備份）</span>
                    <span class="lang-en" style="display:none;">(Not uploaded to server, please backup yourself)</span>
                </p>
            </div>
            <div class="modal-foot">
                <button onclick="proceedSave()" class="btn btn-success btn-3d" style="margin-right: 10px;">
                    <span class="lang-zh">✓ 確認</span>
                    <span class="lang-en" style="display:none;">✓ Confirm</span>
                </button>
                <button onclick="document.getElementById('saveNoticeModal').style.display='none'" class="btn btn-danger btn-3d">
                    <span class="lang-zh">✕ 取消</span>
                    <span class="lang-en" style="display:none;">✕ Cancel</span>
                </button>
            </div>
        </div>
    </div>

  <style>
    /* 梅花間竹：相鄰相反相位，上下交替 */

    @keyframes alt-up { 
      0% { transform: translateY(-8px); }
      50% { transform: translateY(8px); }
      100% { transform: translateY(-8px); }
    }
    @keyframes alt-down { 
      0% { transform: translateY(8px); }
      50% { transform: translateY(-8px); }
      100% { transform: translateY(8px); }
    }
    .alt-up { animation: alt-up 2.8s ease-in-out infinite !important; }
    .alt-down { animation: alt-down 2.8s ease-in-out infinite !important; }
    /* 其餘使用 A/B 交替類名即可 */
    /* 無需設定任何 delay，確保純相位相反、速度一致 */
    /* 版位與對齊優化（標題置中、按鈕文字垂直置中） */
    .welcome-title { justify-content: center; text-align: center; }
    .welcome-actions { align-items: center; }
    .welcome-btn { display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
    /* 按鈕高度一致，文字上下居中 */
    .welcome-btn, .welcome-btn.primary { min-height: 40px; }

    /* 依語言調整標題字級，避免英文過度迫近圖案 */
    #welcomeOverlay[data-lang="en"] .welcome-title .welcome-text { font-size: 2.1rem; text-align: center; }
    #welcomeOverlay[data-lang="zh"] .welcome-title .welcome-text { font-size: 2.4rem; text-align: center; }

    /* 語言切換圓形按鈕（文字不出界） */
    .lang-toggle {
      position: absolute;
      top: 10px; right: 10px;
      width: 48px; height: 48px;
      border-radius: 50%;
      background: rgba(255,255,255,0.18);
      color: #fff; border: 0; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      padding: 0; margin: 0;
      font-size: 0.72rem; font-weight: 700; line-height: 1; user-select: none; white-space: nowrap;
      overflow: hidden; text-overflow: clip;
      transition: background .2s ease, transform .12s ease;
    }
    .lang-toggle:hover { background: rgba(255,255,255,0.26); transform: translateY(-1px); }

  </style>

  <!-- 歡迎視窗（僅首次） -->
  <div id="welcomeOverlay" class="welcome-overlay" aria-hidden="true" role="dialog">
    <canvas id="confettiCanvas" class="confetti-canvas"></canvas>
    <div class="welcome-modal" role="document" aria-label="歡迎">
      <button id="langToggle" class="lang-toggle" type="button" aria-label="語言切換">中 / EN</button>
      <div class="welcome-title">
            <span class="emoji alt-up">🎉</span>
            <span class="emoji alt-down">🎈</span>
            <span class="emoji alt-up">🥳</span>
            <span class="welcome-text">歡迎！</span>
            <span class="emoji alt-down">🎊</span></div>
      <div class="welcome-body">
        祝您使用愉快。
      </div>
      
            <div class="welcome-disclaimer">
                此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。
            </div>

            <div class="welcome-actions">
        <button id="welcomeLater" class="welcome-btn" type="button" onclick="exitApp()">稍後再看</button>
        <button id="welcomeStart" class="welcome-btn primary" type="button">開始使用</button>
      </div>
    </div>
  </div>

  
    <!-- QR Modal -->
    <div id="qrModal" class="qr-modal" aria-hidden="true" style="display:none;">
        <div class="qr-backdrop"></div>
        <div class="qr-dialog" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
            <button class="qr-close" id="qrClose" aria-label="關閉"><i class="fas fa-times"></i></button>
            <h3 id="qrTitle" class="qr-header"><i class="fas fa-qrcode"></i> QR Code</h3>
            <div id="qrCode" class="qr-code"></div>
            <div class="qr-info">
                <div class="qr-row"><span class="qr-label">名稱：</span><span id="qrName" class="qr-value"></span></div>
                <div class="qr-row"><span class="qr-label">網址：</span><a id="qrUrl" class="qr-link" href="#" target="_blank" rel="noopener"></a></div>
            </div>
        </div>
    </div>

    <style>
        .qr-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1100; }
        .qr-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--section-bg); color: inherit; border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.35); width: min(92vw, 420px); padding: 18px 18px 22px; z-index: 1110; border: 1px solid rgba(255,255,255,0.25); }
        .qr-header { margin: 0 0 12px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .qr-close { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.35); color: inherit; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qr-close:hover { background: rgba(255,255,255,0.35); }
        .qr-code { width: 220px; height: 220px; margin: 8px auto 14px; background: rgba(255,255,255,0.9); border-radius: 12px; display:flex; align-items:center; justify-content:center; }
        .qr-info { font-size: 0.95rem; line-height: 1.6; }
        .qr-row { display: flex; align-items: center; gap: 6px; }
        .qr-label { color: var(--text-light); opacity: 0.85; }
        .qr-link { color: #2b6cb0; word-break: break-all; }
        @media (prefers-color-scheme: dark) { .qr-link { color: #7ab0ff; } }
    </style>

    <style>
        /* 最終覆蓋：強制對齊與顏色（不透明灰、黑字） */
        button#languageToggle.language-toggle,
        button#qrButton.qr-toggle { 
            position: fixed !important;
            right: calc(10px + env(safe-area-inset-right)) !important;
            width: 42px !important;
            height: 42px !important;
            border-radius: 50% !important;
            background: #f0f0f0 !important; /* 灰色、不透明 */
            color: #000 !important;          /* 黑色文字 */
            border: 1px solid #ccc !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
            font-size: 0.9rem !important;
            font-weight: 700 !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.20) !important;
            text-shadow: none !important;
            z-index: 1000 !important;
            transition: none !important; /* 取消任何變色過渡 */
        }
        button#languageToggle.language-toggle { top: calc(10px + env(safe-area-inset-top)) !important; }
        button#qrButton.qr-toggle { top: calc(10px + env(safe-area-inset-top) + 52px) !important; }
        button#languageToggle.language-toggle:hover,
        button#qrButton.qr-toggle:hover,
        button#languageToggle.language-toggle:active,
        button#qrButton.qr-toggle:active { 
            background: #f0f0f0 !important; color: #000 !important; transform: none !important; 
        }
        @media (max-width: 600px) {
            button#languageToggle.language-toggle,
            button#qrButton.qr-toggle { width: 36px !important; height: 36px !important; font-size: 0.85rem !important; }
            button#qrButton.qr-toggle { top: calc(10px + env(safe-area-inset-top) + 45px) !important; }
        }
        /* QR 視窗改為灰色主題 */
        .qr-backdrop { background: rgba(0,0,0,0.5) !important; }
        .qr-dialog { background: #e9e9e9 !important; color: #000 !important; border-radius: 14px !important; border: 1px solid #cfcfcf !important; }
        .qr-header { color: #000 !important; }
        .qr-close { background: #d9d9d9 !important; color: #000 !important; border-color: #c0c0c0 !important; }
        .qr-close:hover { background: #cfcfcf !important; }
        .qr-code { background: #fff !important; }
        .qr-label { color: #333 !important; }
        .qr-link { color: #000 !important; }
    </style>

    <style>
        /* 以類名 fixed-btn 作最後保險覆蓋（含 !important）*/
        .fixed-btn { /* 保留個別按鈕色彩，由 inline 與下方覆蓋決定 */ }
    </style>

    <style>
  /* 最終色彩保險：強制顏色顯示 */
  :root { --language-bg: #90EE90; }
  #languageToggle.language-toggle { background-color: var(--language-bg) !important; color: #000 !important; border: 1px solid #7fd67f !important; }
  #qrButton.qr-toggle { background-color: #555 !important; color: #fff !important; border: 1px solid #333 !important; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        (function(){
            const appUrl = 'https://cw91020251212.github.io/Dorm-score-calculator/';
            const appName = (document.getElementById('appTitle')?.textContent || document.title || '宿舍分數計算器').trim();
            const btn = document.getElementById('qrButton');
            const modal = document.getElementById('qrModal');
            const closeBtn = document.getElementById('qrClose');
            const qrBox = document.getElementById('qrCode');
            const nameEl = document.getElementById('qrName');
            const urlEl = document.getElementById('qrUrl');
            function openModal(){
                // Clear previous QR
                qrBox.innerHTML = '';
                // Generate QR
                new QRCode(qrBox, { text: appUrl, width: 220, height: 220 });
                // Fill info
                nameEl.textContent = appName;
                urlEl.textContent = appUrl;
                urlEl.href = appUrl;
                // Show
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden','false');
                // ESC to close
                document.addEventListener('keydown', onEsc);
            }
            function closeModal(){
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden','true');
                document.removeEventListener('keydown', onEsc);
            }
            function onEsc(e){ if(e.key === 'Escape') closeModal(); }
            // Backdrop click closes
            modal.addEventListener('click', function(e){ if(e.target.classList.contains('qr-backdrop')) closeModal(); });
            closeBtn.addEventListener('click', closeModal);
            if(btn) btn.addEventListener('click', openModal);
        })();
    </script>

</body>
</html>
