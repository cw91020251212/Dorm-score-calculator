<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宿舍分數計算器 - 優化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #0f2a4a;
            --accent: #4f9de8;
            --accent-dark: #347fd3;
            --success: #28a745;
            --success-dark: #218838;
            --warning: #ffc107;
            --warning-dark: #e0a800;
            --danger: #e84f4f;
            --danger-dark: #d33a3a;
            --text-light: #fff;
            --text-dark: #333;
            --card-bg: rgba(255, 255, 255, 0.08);
            --section-bg: rgba(30, 58, 95, 0.7);
            --required: #ff6b6b;
            --hint-pink: #ffb6c1;
            --language-bg: rgba(144, 238, 144, 0.8); /* 淺綠色背景 */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            font-size: 18px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        header {
            text-align: center;
            padding: 25px;
            background: var(--section-bg);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            /* 以 clamp 做自適應，進一步縮細，確保任何裝置一行內完全顯示 */
            font-size: clamp(1.5rem, 4.8vw, 2.0rem);
            line-height: 1.1;
            margin-bottom: 8px;
            color: #fff;
            /* 降低光暈，避免視覺膨脹感 */
            text-shadow: 0 0 6px rgba(79, 157, 232, 0.5),
                         0 0 12px rgba(79, 157, 232, 0.35);
            position: relative;
            z-index: 2;
            letter-spacing: 0.5px;
            font-weight: 700;
            white-space: nowrap; /* 強制單行顯示 */
        }
        
        h1 i {
            color: #ffc107;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a0c8ff;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .form-section {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .section-title {
            font-size: 1.8rem;
            color: var(--accent);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
            font-size: 1.1rem;
        }
        
        .required::after {
            content: "*";
            color: var(--required);
            margin-left: 4px;
            font-weight: bold;
        }
        
        .input-control {
            width: 100%;
            padding: 14px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 18px;
        }
        
        .input-control.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(232, 79, 79, 0.3);
        }
        
        .input-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79, 157, 232, 0.3);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .input-hint {
            font-size: 0.75rem; /* 縮小字體兩級 */
            color: var(--hint-pink);
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }
        
        /* 按鈕文字黑色邊框效果 */
        .btn span {
            position: relative;
            z-index: 2;
            text-shadow: none;
        }
        
        /* 特殊按鈕 - 無文字陰影 */
        .btn.no-text-shadow span {
            text-shadow: none !important;
        }
        
        /* 計算按鈕 - 醒目漸變設計 */
        .btn-primary {
            background: linear-gradient(135deg, #4f9de8, #ffc107);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-primary:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffc107, #4f9de8);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .btn-primary:hover:before {
            opacity: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .btn-primary i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--text-dark);
        }
        
        .btn-warning:hover {
            background: var(--warning-dark);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }
        
        .result-section {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .result-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
            overflow-y: auto;
            font-size: 1.1rem;
        }
        
        .result-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
            font-size: 1.2rem;
        }
        
        .result-placeholder i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        .highlight-score {
            display: block;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px 0;
            color: var(--warning);
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 2px solid var(--warning);
        }
        
        .result-details {
            margin-top: 20px;
        }
        
        .result-item {
            padding: 18px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 1.1rem;
        }
        
        .result-label {
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 1.2rem;
        }
        
        .result-value {
            color: #fff;
        }
        
        .data-section {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            grid-column: 1 / -1;
        }
        
        .data-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 14px 14px 45px;
            font-size: 18px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            font-size: 1.3rem;
        }
        
        .data-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--accent);
            transition: all 0.3s;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent);
        }
        
        .card-date {
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .card-score {
            font-size: 2rem;
            text-align: center;
            margin: 20px 0;
            color: var(--warning);
        }
        
        .card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .detail-item {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            padding: 12px;
        }
        
        .detail-label {
            font-size: 0.95rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-btn span {
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        .load-btn {
            background: var(--accent);
            color: white;
        }
        
        .load-btn:hover {
            background: var(--accent-dark);
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .delete-btn:hover {
            background: var(--danger-dark);
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
            grid-column: 1 / -1;
            font-size: 1.2rem;
        }
        
        .no-data i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        footer {
            text-align: center;
            padding: 30px 20px 20px;
            margin-top: 20px;
            color: #aaa;
        }
        
        /* 狀態欄優化 - 更細更精緻 */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .status-message {
            font-size: 0.95rem;
            color: yellow;
        }
        
        .status-actions {
            display: flex;
            gap: 10px;
        }
        
        .status-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-btn span {
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .data-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.3rem; /* 手機上再細少少 */
            }
        }
        
        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .section-title {
                font-size: 1.6rem;
            }
            
            body {
                font-size: 16px;
            }
            
            /* 手機版語言按鈕調整 */
            .language-toggle {
                top: 15px !important;
                right: 15px !important;
                font-size: 0.8rem !important;
                padding: 6px 12px !important;
            }
        }
        
        /* 打印样式 */
        @media print {
            body {
                background: white;
                color: black;
                padding: 10mm;
            }
            
            .container, .form-section, .result-section {
                box-shadow: none;
                background: white;
            }
            
            .button-group, .data-section, .status-bar, footer, .language-toggle {
                display: none;
            }
            
            .result-container {
                background: white;
                color: black;
                border: 1px solid #ccc;
            }
            
            .highlight-score {
                color: #1e3a5f;
            }
        }
        
        /* 標題裝飾效果 - 多色設計 */
        .header-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: hidden;
        }
        
        .decoration-circle {
            position: absolute;
            border-radius: 50%;
            animation: float 15s infinite ease-in-out;
        }
        
        .circle-1 {
            width: 120px;
            height: 120px;
            top: -30px;
            right: -30px;
            background: rgba(79, 157, 232, 0.1);
        }
        
        .circle-2 {
            width: 80px;
            height: 80px;
            bottom: -20px;
            left: -20px;
            background: rgba(255, 182, 193, 0.15);
        }
        
        .circle-3 {
            width: 60px;
            height: 60px;
            top: 50%;
            left: 20%;
            background: rgba(255, 193, 7, 0.15);
        }
        
        .circle-4 {
            width: 100px;
            height: 100px;
            bottom: 20px;
            right: 100px;
            background: rgba(40, 167, 69, 0.15);
        }
        
        .circle-5 {
            width: 90px;
            height: 90px;
            top: 20px;
            left: 15%;
            background: rgba(232, 79, 79, 0.15);
        }
        
        .circle-6 {
            width: 70px;
            height: 70px;
            top: 40%;
            right: 15%;
            background: rgba(159, 79, 232, 0.15);
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0);
            }
            25% {
                transform: translate(5px, 10px);
            }
            50% {
                transform: translate(-10px, 5px);
            }
            75% {
                transform: translate(8px, -7px);
            }
        }
        
        /* 新增標題閃光效果 - 速度減慢 */
        @keyframes shine {
            0% {
                background-position: -500px;
            }
            100% {
                background-position: 500px;
            }
        }
        
        h1 {
            position: relative;
        }
        
        h1:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shine 5s infinite linear; /* 從3s改為5s，使動畫變慢 */
            z-index: -1;
        }
        
        /* 語言切換按鈕 - 修正位置到右上角，避免覆蓋標題 */
        .language-toggle {
            position: fixed; /* 改為 fixed 定位 */
            top: 20px; /* 距離頂部 20px */
            right: 20px; /* 距離右邊 20px */
            background: var(--language-bg); /* 使用淺綠色背景 */
            color: #333; /* 深色文字 */
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            padding: 10px 18px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000; /* 確保在最上層 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: bold;
            text-shadow: none; /* 移除文字陰影 */
        }
        
        .language-toggle:hover {
            background: rgba(152, 251, 152, 0.95); /* 加深背景色 */
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        .language-toggle:active {
            transform: translateY(0) scale(0.98);
        }
            /* 簡化模式：只保留「儲存」＋「載入」按鈕 */
            .search-box { display: none !important; }
            #importBtn { display: none !important; }
            #savePdfBtn { display: none !important; }
            #exportBtn { display: none !important; }
            .status-actions { display: none !important; }
            .data-section { display: none !important; }
            /* 兩個按鈕水平排列（手機亦保持橫排） */
            @media (max-width: 600px) {
                .button-group { flex-direction: row !important; }
            }
            /* 強制兩個主要按鈕水平排列 */
            .button-group { flex-direction: row !important; justify-content: flex-start; align-items: center; gap: 12px; }
            .button-group .btn { flex: 0 0 auto; min-width: 160px; }
            /* 顯示調校控制：A+/A- + 亮度 */
            /* 顯示調校工具列（置於標題區右下角，不遮標題） */
            /* 工具列改為正常文流，不覆蓋內容，置中顯示於標題下方 */
            .display-controls { position: static; margin: 24px auto 28px; z-index: 1; display: flex; gap: 8px; align-items: center; justify-content: center; background: rgba(255,255,255,0.10); padding: 4px 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); max-width: 76%; }
            /* 讓 header 內部元素遵循文流 */
            header { position: relative; overflow: visible; }
            .display-label { font-size: 0.85rem; color: var(--text-light); margin-right: 4px; opacity: 0.9; }
            /* 使用現有 .btn 風格但縮細尺寸 */
            .btn-small { padding: 5px 8px; font-size: 13px; min-width: auto; line-height: 1; }
            /* 主題模式：亮／暗（覆蓋色板變數） */
            /* 粉色主題（Pastel Pink）統一風格 */
            .theme-light { 
                --primary: #f8f1f4; /* 粉白背景 */
                --primary-dark: #f0e4ea; /* 稍深粉白 */
                --accent: #f28fb1; /* 柔粉重點色 */
                --accent-dark: #d96a8f; /* 深粉重點色 */
                --success: #86c5a6; /* 柔和綠 */
                --warning: #f3c27a; /* 柔和黃 */
                --danger: #e07a8c; /* 柔和紅 */
                --text-light: #fff; /* 光明版主要文字改深色 */
                --text-dark: #111; 
                --card-bg: rgba(255, 255, 255, 0.95);
                --section-bg: rgba(255, 255, 255, 0.98);
            }
            .theme-light body { color: var(--text-light); }
            .theme-light .input-control { background: #ffffff; color: #333; border-color: #c88fa1; }
            .theme-light .section-title { color: #2b6cb0; border-color: #2b6cb0; }
            .theme-light .highlight-score { color: var(--warning); border-color: var(--warning); background: rgba(255,255,255,0.7); }
            .theme-light body { color: var(--text-dark); }
            .theme-light .form-section, .theme-light .result-section, .theme-light .data-section { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
            .theme-light .highlight-score { color: var(--warning); border-color: var(--warning); background: rgba(255,255,255,0.8); }
            /* 標題高度微縮 */
            header { padding: 12px 16px 20px !important; }
            h1 { font-size: 2.8rem !important; }
            /* 修正輸入欄位行高，避免字體縮放後擠壓或截斷 */
            .input-control { line-height: 1.5 !important; }
            /* 語言切換：浮動圓形按鈕（不影響版面），兼容瀏海安全距 */
            .language-toggle {
                position: fixed;
                top: calc(10px + env(safe-area-inset-top));
                right: calc(10px + env(safe-area-inset-right));
                width: 42px;
                height: 42px;
                border-radius: 50%;
                background: var(--language-bg);
                color: #333;
                border: 1px solid rgba(255, 255, 255, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                z-index: 1000;
                box-shadow: 0 3px 8px rgba(0,0,0,0.25);
                font-weight: bold;
                text-shadow: none;
            }
            .language-toggle:hover { transform: translateY(-1px) scale(1.03); }
            .language-toggle:active { transform: translateY(0) scale(0.98); }
            @media (max-width: 600px) {
                .language-toggle { width: 36px; height: 36px; font-size: 0.8rem; }
            }
            /* 工具列按鈕風格：跟輸入欄的淺藍透明效果，降低存在感 */
            .display-controls .btn,
            .display-controls .btn-small {
                background: rgba(255,255,255,0.12) !important;
                color: var(--text-light) !important;
                border: 1px solid rgba(255,255,255,0.25) !important;
                box-shadow: none !important;
            }
            .display-controls .btn-small:hover { background: rgba(255,255,255,0.16) !important; }
            .display-controls .btn-small { height: 26px; padding: 3px 8px; font-size: 13px; }
            /* 光明版下的工具列與文字可讀性優化 */
            .theme-light .display-controls { background: rgba(0,0,0,0.05) !important; border-color: rgba(0,0,0,0.10) !important; }
            .theme-light .display-controls .btn,
            .theme-light .display-controls .btn-small { background: rgba(0,0,0,0.06) !important; color: #222 !important; border: 1px solid rgba(0,0,0,0.12) !important; }
            /* 光明版整體文字顏色加深，避免過淺看不清 */
            .theme-light label,
            .theme-light .input-control,
            .theme-light .result-value,
            .theme-light .result-label { color: #222 !important; }
            /* 新增：較淺的黑暗版（theme-dark）配色，減低整體黑度但保持對比度 */
            .theme-dark {
                --primary: #27486f;           /* 由 #1e3a5f 提亮 */
                --primary-dark: #1a3658;      /* 由 #0f2a4a 提亮 */
                --accent: #7fb3e9;            /* 重點色偏淺藍，易讀 */
                --accent-dark: #4f94d9;
                --section-bg: rgba(30, 58, 95, 0.60);  /* 由 0.70 降到 0.60，少啲暗 */
                --card-bg: rgba(255, 255, 255, 0.06);  /* 稍微提亮卡片層 */
                --text-light: #f2f5f9;        /* 文字偏淺但唔係純白，減刺眼 */
            }
            /* 黑暗版下的輸入欄：微提亮背景與邊框，增可讀性 */
            .theme-dark .input-control {
                background: rgba(255, 255, 255, 0.12);
                border-color: rgba(255, 255, 255, 0.25);
                color: #f2f5f9;
            }
            /* 覆蓋定義：按你的要求重設深色／光明主題的配色與風格 */
            .theme-dark {
                /* 還原至原來的深色主題（作為基準版本） */
                --primary: #1e3a5f;
                --primary-dark: #0f2a4a;
                --accent: #4f9de8;
                --accent-dark: #347fd3;
                --section-bg: rgba(30, 58, 95, 0.70);
                --card-bg: rgba(255, 255, 255, 0.08);
                --text-light: #fff;
            }
            .theme-dark .input-control { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: var(--text-light); }
            
            .theme-light {
                /* 光明版：以深色主題為基礎整體提亮、透明度降低 */
                --primary: #2a5175; 
                --primary-dark: #184364; 
                --accent: #4f9de8; 
                --accent-dark: #347fd3; 
                --success: #86c5a6; 
                --warning: #f3c27a; 
                --danger: #e07a8c; 
                --text-light: #fff; 
                --text-dark: #111; 
                --card-bg: rgba(255, 255, 255, 0.12);
                --section-bg: rgba(30, 58, 95, 0.50);
            }
            .theme-light .input-control { background: rgba(255,255,255,0.12); color: #fff; border-color: rgba(255,255,255,0.30); }
            /* 覆蓋：光明版文字顏色保持白色，避免早前 #222 覆蓋 */
            .theme-light label,
            .theme-light .result-value,
            .theme-light .result-label { color: #fff !important; }
            /* 光明版全面提亮（整體更亮），並保持白色文字清晰可讀 */
            .theme-light {
                --primary: #8e9caf;          /* 亮：極淡粉白 */
                --primary-dark: #8794a4;     /* 亮：極淡暖白 */
                --accent: #7ec8ff;           /* 亮：柔藍重點色 */
                --accent-dark: #4f9de8;      /* 原藍作深重點 */
                --success: #8bd6b1;          /* 亮：柔綠 */
                --warning: #ffd07a;          /* 亮：柔黃 */
                --danger: #f59aa7;           /* 亮：柔紅 */
                --text-light: #fff;          /* 亮版仍用白字（你的要求） */
                --text-dark: #111;           
                --section-bg: rgba(30,58,95,0.65); /* 區塊背景加深透明度，讓白字有對比 */
                --card-bg: rgba(255,255,255,0.10);  /* 卡片微亮，不刺眼 */
            }
            .theme-light body { 
                background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important; 
                color: var(--text-light) !important; 
            }
            .theme-light .form-section, .theme-light .result-section, .theme-light .data-section { 
                background: var(--section-bg) !important; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.18) !important; 
            }
            /* 亮版下：輸入欄與按鈕跟隨整體風格，加深邊界提升可讀性 */
            .theme-light .input-control { 
                background: rgba(255,255,255,0.12) !important; 
                color: #fff !important; 
                border-color: rgba(255,255,255,0.30) !important; 
            }
            .theme-light .btn { 
                background: rgba(255,255,255,0.14) !important; 
                color: #fff !important; 
                border: 1px solid rgba(255,255,255,0.28) !important; 
                box-shadow: none !important; 
            }
            .theme-light .btn:hover { 
                background: rgba(255,255,255,0.18) !important; 
            }
            .theme-light .section-title { 
                color: var(--accent) !important; 
                border-color: var(--accent) !important; 
            }
            /* 需求：光明版輸入文字保持白色；按鈕用粉色與淺色系 */
            /* 1) 光明版：輸入區與標籤、提示等文字全部保持白色 */
            .theme-light label,
            .theme-light .input-hint,
            .theme-light .result-label,
            .theme-light .result-value { color: #fff !important; }
            .theme-light .input-control { color: #fff !important; }
            .theme-light .input-control::placeholder { color: rgba(255,255,255,0.75) !important; }
            /* 兼容部分瀏覽器的自動填充顏色 */
            .theme-light input:-webkit-autofill,
            .theme-light input:-webkit-autofill:focus {
                -webkit-text-fill-color: #fff !important;
                transition: background-color 5000s ease-in-out 0s !important;
            }

            /* 2) 光明版：按鈕用粉色與淺色系，保留原有類型但轉為柔和色階 */
            .theme-light .btn { 
                background: rgba(255,255,255,0.14) !important; 
                color: #fff !important; 
                border: 1px solid rgba(255,255,255,0.28) !important; 
                box-shadow: none !important; 
            }
            .theme-light .btn:hover { background: rgba(255,255,255,0.18) !important; }
            /* 類型色階（柔和粉系） */
            .theme-light .btn-primary { 
                background: linear-gradient(135deg, #f7a1c1, #ffd5a8) !important; 
            }
            .theme-light .btn-success { background: #8bd6b1 !important; }
            .theme-light .btn-warning { background: #ffd07a !important; color: #333 !important; }
            .theme-light .btn-danger  { background: #f59aa7 !important; }
            /* 工具列按鈕也採用同一套柔和色階 */
            .theme-light .display-controls .btn,
            .theme-light .display-controls .btn-small { 
                background: rgba(255,255,255,0.14) !important; 
                color: #fff !important; 
                border: 1px solid rgba(255,255,255,0.28) !important; 
            }

            /* 3) 光明版：輸入框邊界加深一點，確保白字易讀 */
            .theme-light .input-control { 
                border-color: rgba(255,255,255,0.30) !important; 
                background: rgba(255,255,255,0.12) !important; 
            }
    </style>
        <style>
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 2000; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: min(720px, 92vw); max-height: 80vh; overflow: auto; background: var(--section-bg); color: var(--text-light); border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); z-index: 2001; display: none; }
        .modal header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: space-between; }
        .modal header h3 { font-size: 1.3rem; color: var(--accent); margin: 0; }
        .modal .modal-body { padding: 16px 20px; }
        .modal .modal-body ul { margin-left: 18px; }
        .modal .modal-foot { padding: 12px 20px 18px; border-top: 1px solid rgba(255,255,255,0.2); text-align: right; }
        .modal .close-btn { background: var(--warning); color: var(--text-dark); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 14px; cursor: pointer; }
        .modal .close-btn:hover { background: var(--warning-dark); }
        .modal .label { color: #a0c8ff; font-weight: bold; }
        @media (max-width: 600px) { .modal header h3 { font-size: 1.1rem; } .modal .modal-body { font-size: 0.95rem; } }
        </style>
<style>
.shake { animation: shake 320ms ease-in-out 2; }
@keyframes shake {
    0%   { transform: translateX(0); }
    25%  { transform: translateX(-4px); }
    50%  { transform: translateX(4px); }
    75%  { transform: translateX(-3px); }
    100% { transform: translateX(0); }
}
</style>
<style>
.glow-yellow { box-shadow: 0 0 0 3px rgba(255,193,7,0.45), 0 0 12px rgba(255,193,7,0.55) !important; }
.glow-red { box-shadow: 0 0 0 3px rgba(232,79,79,0.45), 0 0 12px rgba(232,79,79,0.55) !important; }
</style>
<style>
.disclaimer { color: #ffd07a; font-size: 0.95rem; margin-top: 8px; opacity: 0.9; }
</style>
<style>
/* 在光明版，將總分改為深色字＋白底，提升對比 */
.theme-light .highlight-score {
  color: #1a2b44 !important;              /* 深藍字，對比高 */
  background: rgba(255,255,255,0.98) !important; /* 幾乎白底 */
  border-color: #1a2b44 !important;       /* 同色邊框 */
  text-shadow: none !important;           /* 移除光暈，字更銳利 */
}
</style>
<style>
/* 淡藍框：令整體更專業、更易讀 */
.modal {
  border: 2px solid rgba(126, 200, 255, 0.45) !important; /* 外框淡藍 */
  box-shadow: 0 12px 28px rgba(79, 157, 232, 0.25), 0 4px 10px rgba(0,0,0,0.25) !important; /* 藍色陰影＋柔和立體感 */
}
.modal header, .modal .modal-foot {
  background: rgba(126, 200, 255, 0.08) !important; /* 頭／尾淡藍底 */
}
.modal .modal-body {
  background: rgba(126, 200, 255, 0.12) !important; /* 內容區淡藍半透明底 */
  border: 1px solid rgba(126, 200, 255, 0.30) !important; /* 內容區細框 */
  border-radius: 10px !important;
}

        /* ===== 光明版：只改紅圈位置文字為黑色 ===== */
        .theme-light #calcBtn, .theme-light #resetBtn {
            color: #000 !important;
        }
        .theme-light #calcBtn span, .theme-light #resetBtn span {
            color: #000 !important;
            text-shadow: none !important;
        }
        .theme-light .disclaimer {
            color: #000 !important;
        }
        .theme-light #saveDataBtn,
        .theme-light button[onclick*="clearAllData"],
        .theme-light .btn-danger {
            color: #000 !important;
        }
        .theme-light #saveDataBtn span,
        .theme-light button[onclick*="clearAllData"] span,
        .theme-light .btn-danger span {
            color: #000 !important;
            text-shadow: none !important;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-decoration">
                <div class="decoration-circle circle-1"></div>
                <div class="decoration-circle circle-2"></div>
                <div class="decoration-circle circle-3"></div>
                <div class="decoration-circle circle-4"></div>
                <div class="decoration-circle circle-5"></div>
                <div class="decoration-circle circle-6"></div>
            </div>
            
            <h1><i class="fas fa-calculator"></i> <span id="appTitle">宿舍分數計算器</span></h1>
        <div class="display-controls" aria-label="顯示調校工具列">
            
            <button id="fontInc" class="btn btn-warning no-text-shadow btn-small" title="Increase text"><i class="fas fa-plus"></i></button>
            <button id="fontDec" class="btn btn-warning no-text-shadow btn-small" title="Decrease text"><i class="fas fa-minus"></i></button>
            
            <button id="themeToggle" class="btn btn-warning no-text-shadow btn-small" title="Toggle theme"><i class="fas fa-circle-half-stroke"></i></button>
            
            <button id="infoBtn" type="button" class="btn btn-warning no-text-shadow btn-small" title="使用須知"><i class="fas fa-info-circle"></i></button>
        </div>
        </header>
        
        <button id="languageToggle" class="language-toggle" aria-label="切換語言">EN</button>
        
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-edit"></i> <span id="inputSectionTitle">輸入資料</span></h2>
                
                <div class="form-group">
                    <label for="salary" class="required"><span id="salaryLabel">薪金（港幣）</span></label>
                    <input type="number" id="salary" class="input-control" placeholder="例如：30000" min="0">
                </div>
                
                <div class="form-group">
                    <label for="divisor" class="required"><span id="divisorLabel">除數</span></label>
                    <input type="number" id="divisor" class="input-control" value="538" min="1">
                    <div class="input-hint"><span id="divisorHint">目前預設值538，請參考最新宿舍手冊</span></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="hireDate" class="required"><span id="hireDateLabel">入職日期</span></label>
                        <input type="date" id="hireDate" class="input-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate" class="required"><span id="endDateLabel">截止日期</span></label>
                        <input type="date" id="endDate" class="input-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="spouse"><span id="spouseLabel">配偶在港居住？</span></label>
                    <select id="spouse" class="input-control">
                        <option value="no" selected><span id="spouseNo">否</span></option>
                        <option value="yes"><span id="spouseYes">是</span></option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="children"><span id="childrenLabel">子女人數</span></label>
                        <input type="number" id="children" class="input-control" value="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="overseas"><span id="overseasLabel">海外就讀子女人數</span></label>
                        <input type="number" id="overseas" class="input-control" value="0" min="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newborn"><span id="newbornLabel">新生（在一個月內出生）</span></label>
                        <input type="number" id="newborn" class="input-control" value="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="otherChildren"><span id="otherChildrenLabel">其他子女（除首名）</span></label>
                        <input type="number" id="otherChildren" class="input-control" value="0" min="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="instruction"><span id="instructionLabel">是否被指示離開宿舍？</span></label>
                        <select id="instruction" class="input-control">
                            <option value="no" selected><span id="instructionNo">否</span></option>
                            <option value="yes"><span id="instructionYes">是</span></option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="defect"><span id="defectLabel">宿舍有缺陷？</span></label>
                        <select id="defect" class="input-control">
                            <option value="no" selected><span id="defectNo">否</span></option>
                            <option value="yes"><span id="defectYes">是</span></option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="calcBtn" class="btn btn-primary">
                        <i class="fas fa-calculator"></i> <span id="calcBtnText">計算分數</span>
                    </button>
                    <button id="resetBtn" class="btn btn-danger">
                        <i class="fas fa-redo"></i> <span id="resetBtnText">重置表單</span>
                    </button>
                </div>
            </div>
            
            <div class="result-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> <span id="resultSectionTitle">計算結果</span></h2>
<p id="disclaimerResult" class="disclaimer">此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。</p>
                
                <div class="result-container">
                    <div class="result-placeholder" id="resultPlaceholder">
                        <i class="fas fa-file-alt"></i>
                        <p><span id="resultPlaceholderText">填寫左側表單後點擊「計算分數」</span></p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="saveDataBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> <span id="saveBtnText">儲存目前資料</span>
                    </button>
                    <button id="cancelSaveBtn" class="btn btn-danger no-text-shadow" title="刪除已儲存的資料">
                        <i class="fas fa-ban"></i> <span id="cancelSaveText">取消儲存</span>
                    </button>
                    <select id="deleteSelect" class="input-control" style="max-width: 280px; display: none; margin-left: 10px;"></select>
                    <button id="loadBtn" class="btn btn-warning no-text-shadow">
                        <i class="fas fa-download"></i> <span id="loadText">載入資料</span>
                    </button>
                    <select id="loadSelect" class="input-control" style="max-width: 280px; display: none; margin-left: 10px;"></select>
                </div>
            </div>
            
            <div class="data-section">
                <h2 class="section-title"><i class="fas fa-database"></i> <span id="dataSectionTitle">已儲存資料</span></h2>
                
                <div class="data-controls">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchData" class="input-control" placeholder="搜尋儲存資料...">
                    </div>
                    
                    <button id="exportBtn" class="btn btn-warning no-text-shadow">
                        <i class="fas fa-file-export"></i> <span id="exportBtnText">匯出所有資料</span>
                    </button>
                    
                    <button id="importBtn" class="btn btn-success">
                        <i class="fas fa-file-import"></i> <span id="importBtnText">匯入資料</span>
                    </button>
                </div>
                
                <div class="data-container">
                    <div class="no-data" id="noDataMessage">
                        <i class="fas fa-database"></i>
                        <h3><span id="noDataTitle">尚未儲存任何資料</span></h3>
                        <p><span id="noDataHint">請使用「儲存目前資料」按鈕保存您的計算結果</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p id="disclaimerFooter" class="disclaimer">此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。</p>
        </footer>
    </div>
    
    <div class="status-bar">
        <div class="status-message">
            <i class="fas fa-info-circle"></i> <span id="statusText">系統準備就緒，請填寫表單開始計算</span>
        </div>
        <div class="status-actions">
            <button class="status-btn" style="background: var(--accent); color: white;">
                <i class="fas fa-cloud"></i> <span id="backupStatus">自動備份已啟用</span>
            </button>
            <button class="status-btn" style="background: var(--success); color: white;">
                <i class="fas fa-database"></i> <span id="dataStatus">已儲存 <span id="dataCount">0</span> 筆資料</span>
            </button>
        </div>
    </div>

    <script>
        // 語言設置
        let currentLang = 'zh';
        const translations = {
            'zh': {
                'appTitle': '宿舍分數計算器',
                'inputSectionTitle': '輸入資料',
                'salaryLabel': '薪金（港幣）',
                'divisorLabel': '除數',
                'divisorHint': '目前預設值538，請參考最新宿舍手冊',
                'hireDateLabel': '入職日期',
                'endDateLabel': '截止日期',
                'spouseLabel': '配偶在港居住？',
                'spouseNo': '否',
                'spouseYes': '是',
                'childrenLabel': '子女人數',
                'overseasLabel': '海外就讀子女人數',
                'newbornLabel': '新生（在一個月內出生）',
                'otherChildrenLabel': '其他子女（除首名）',
                'instructionLabel': '是否被指示離開宿舍？',
                'instructionNo': '否',
                'instructionYes': '是',
                'defectLabel': '宿舍有缺陷？',
                'defectNo': '否',
                'defectYes': '是',
                'calcBtnText': '計算分數',
                'resetBtnText': '重置表單',
                'resultSectionTitle': '計算結果',
                'resultPlaceholderText': '填寫左側表單後點擊「計算分數」',
                'saveBtnText': '儲存目前資料',
                'printBtnText': '列印結果',
                'dataSectionTitle': '已儲存資料',
                'exportBtnText': '匯出所有資料',
                'importBtnText': '匯入資料',
                'noDataTitle': '尚未儲存任何資料',
                'noDataHint': '請使用「儲存目前資料」按鈕保存您的計算結果',
                'statusText': '系統準備就緒，請填寫表單開始計算',
                'backupStatus': '自動備份已啟用',
                'dataStatus': '已儲存',
                'langButton': 'English',
                'fontLabel': '字體',
                'themeLabel': '主題',
                'lightLabel': '亮',
                'darkLabel': '暗',
                'cancelSaveText': '取消儲存',
                'loadText': '載入資料',
                    'disclaimerResult': '此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。',
                    'disclaimerFooter': '此計算結果僅供參考；結果不保證準確；本工具不對使用後果負責。',
                    'infoTitle': '使用須知',
                    'scoringLabel': '計分準則（簡述）：',
                    'salaryRule': '薪金分數：薪金 ÷ 除數（預設 538）。',
                    'serviceRule': '年資分數：入職至截止日期的天數 ÷ 365.25 × 年資乘數（預設 6）。',
                    'familyRule': '家庭加分：配偶 +20；每名子女 +10；海外就讀子女 +5；新生 +10；其他子女（除首名）按子女分數並可能有首名加成 +20。',
                    'specialRule': '特殊情況：被指示離開 +72；宿舍有缺陷 +20。',
                    'noticeLabel': '注意事項：',
                    'refOnlyRule': '此計算結果僅供參考，參數或規則可能會改變；請自行核實。',
                    'dateRule': '請確保日期輸入正確（截止日期不可早於入職日期）。',
                    'storageRule': '本工具只在瀏覽器本機儲存資料（localStorage），不會上載伺服器；請自行妥善保管。',
                    'privacyRule': '本工具僅在瀏覽器本機處理及儲存資料；資料不會傳送到任何伺服器或第三方。',
                    'liabilityRule': '任何因使用本工具而引致的後果或損失，本工具不承擔責任。',
                    'closeModalText': '我明白'
            },
            'en': {
                'appTitle': 'Dormitory Score Calculator',
                'inputSectionTitle': 'Input Data',
                'salaryLabel': 'Salary (HKD)',
                'divisorLabel': 'Divisor',
                'divisorHint': 'Default value is 538, please refer to the latest dormitory manual',
                'hireDateLabel': 'Hire Date',
                'endDateLabel': 'End Date',
                'spouseLabel': 'Spouse in Hong Kong?',
                'spouseNo': 'No',
                'spouseYes': 'Yes',
                'childrenLabel': 'Number of Children',
                'overseasLabel': 'Children Studying Overseas',
                'newbornLabel': 'Newborn (within one month)',
                'otherChildrenLabel': 'Other Children (except first child)',
                'instructionLabel': 'Instructed to leave dormitory?',
                'instructionNo': 'No',
                'instructionYes': 'Yes',
                'defectLabel': 'Dormitory has defects?',
                'defectNo': 'No',
                'defectYes': 'Yes',
                'calcBtnText': 'Calculate Score',
                'resetBtnText': 'Reset Form',
                'resultSectionTitle': 'Calculation Result',
                'resultPlaceholderText': 'Fill in the form and click "Calculate Score"',
                'saveBtnText': 'Save Current Data',
                'printBtnText': 'Print Result',
                'dataSectionTitle': 'Saved Data',
                'exportBtnText': 'Export All Data',
                'importBtnText': 'Import Data',
                'noDataTitle': 'No Data Saved',
                'noDataHint': 'Please use "Save Current Data" button to save your calculation',
                'statusText': 'System ready, please fill in the form to start calculation',
                'backupStatus': 'Auto Backup Enabled',
                'dataStatus': 'Saved',
                'langButton': '中文',
                'fontLabel': 'Font',
                'themeLabel': 'Theme',
                'lightLabel': 'Light',
                'darkLabel': 'Dark',
                'cancelSaveText': 'Cancel Save',
                'loadText': 'Load Data',
                    'disclaimerResult': 'Disclaimer: This calculation result is for reference only; accuracy is not guaranteed; this tool is not responsible for any consequences of use.',
                    'disclaimerFooter': 'Disclaimer: This calculation result is for reference only; accuracy is not guaranteed; this tool is not responsible for any consequences of use.',
                    'infoTitle': 'Usage Guide',
                    'scoringLabel': 'Scoring rules (brief):',
                    'salaryRule': 'Salary score: salary ÷ divisor (default 538).',
                    'serviceRule': 'Service score: days from hire to end ÷ 365.25 × multiplier (default 6).',
                    'familyRule': 'Family points: spouse +20; each child +10; child studying overseas +5; newborn +10; other children (except first) per child score, with possible first-child bonus +20.',
                    'specialRule': 'Special cases: instructed to leave +72; dormitory defects +20.',
                    'noticeLabel': 'Notes:',
                    'refOnlyRule': 'The calculation result is for reference only; parameters or rules may change—please verify.',
                    'dateRule': 'Ensure dates are correct (end date cannot be earlier than hire date).',
                    'storageRule': 'This tool only stores data locally in your browser (localStorage); nothing is uploaded—please keep your data safe.',
                    'privacyRule': 'This tool processes and stores your data locally in your browser; no data is transmitted to any server or third party.',
                    'liabilityRule': 'This tool is not responsible for any consequences or losses arising from use.',
                    'closeModalText': 'Got it'
            }
        };
        
        // 切換語言函數
        function setLanguage(lang) {
            const h1El = document.querySelector('header h1');
            currentLang = lang;
            // 英文允許標題換行；中文保持單行（先設置，稍後 fitTitle 再調字級）
            if (h1El) {
                h1El.style.setProperty('white-space', lang === 'en' ? 'normal' : 'nowrap', 'important');
            }
            // 更新所有帶有ID的元素
            Object.keys(translations[lang]).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = translations[lang][key];
                }
            });

            // 【修正】更新所有 lang-zh 和 lang-en 的元素顯示狀態
            document.querySelectorAll('.lang-zh').forEach(el => {
                el.style.display = lang === 'zh' ? '' : 'none';
            });
            document.querySelectorAll('.lang-en').forEach(el => {
                el.style.display = lang === 'en' ? '' : 'none';
            });
            
            // 更新語言按鈕文本 - 修正邏輯：顯示相反的語言名稱
            document.getElementById('languageToggle').textContent = 
                lang === 'zh' ? 'EN' : '中';
            
            // 更新數據狀態文本
            updateDataCount();
            
            // 重新適配標題字級
            if (typeof fitTitle === 'function') fitTitle();
            // 調整標題以適配當前語言字長
            fitTitle();
        }
        
        // 語言切換事件
        document.getElementById('languageToggle').addEventListener('click', function() {
            const newLang = currentLang === 'zh' ? 'en' : 'zh';
            setLanguage(newLang);
        });
        
        // 計算規則
        const scoringRules = {
            spouse: 20,
            child: 10,
            overseasChild: 5,
            newborn: 10,
            firstChildBonus: 20,
            instruction: 72,
            defect: 20,
            serviceMultiplier: 6
        };
        
        // 當前計算結果
        let currentScore = 0;
        
        // 初始化表單數據
        function initForm() {
            const today = new Date();
            document.getElementById('endDate').valueAsDate = today;
            
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            document.getElementById('hireDate').valueAsDate = oneYearAgo;
            
            // 完全清空與重置預設值（避免殘留）
            const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
            setVal('salary', '');            // 清空薪金
            setVal('divisor', '538');       // 回復預設除數
            setVal('spouse', 'no');
            setVal('children', '0');
            setVal('overseas', '0');
            setVal('newborn', '0');
            setVal('otherChildren', '0');
            setVal('instruction', 'no');
            setVal('defect', 'no');
            
            // 收起載入／刪除下拉（如果有打開）
            const loadSelect = document.getElementById('loadSelect');
            const deleteSelect = document.getElementById('deleteSelect');
            if (loadSelect) loadSelect.style.display = 'none';
            if (deleteSelect) deleteSelect.style.display = 'none';
            
            // 重置結果區域
            document.querySelector('.result-container').innerHTML = `
                <div class="result-placeholder" id="resultPlaceholder">
                    <i class="fas fa-file-alt"></i>
                    <p><span id="resultPlaceholderText">${translations[currentLang]['resultPlaceholderText']}</span></p>
                </div>
            `;
            
            // 重置當前分數
            currentScore = 0;
            
            updateStatus(translations[currentLang]['statusText']);
            
            // 重置錯誤狀態
            document.querySelectorAll('.input-control').forEach(input => {
                input.classList.remove('error');
            });
        }
        
        // 更新狀態欄
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        // 平滑捲動到指定元素（正常速度 ~500ms），避免定位混亂
        function scrollToElement(el, duration = 1400, offset = -80) {
            if (!el) return;
            const startY = window.pageYOffset;
            const rect = el.getBoundingClientRect();
            // 目標位置：元素頂部再向上預留少少空間（offset）
            const targetY = rect.top + window.pageYOffset + offset;
            const diff = targetY - startY;
            let startTime = null;
            function easeInOutQuad(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }
            function step(ts) {
                if (!startTime) startTime = ts;
                const progress = Math.min((ts - startTime) / duration, 1);
                const eased = easeInOutQuad(progress);
                window.scrollTo(0, startY + diff * eased);
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // 驗證必填字段
        function validateRequiredFields() {
            const requiredFields = [
                {id: 'salary', name: translations[currentLang]['salaryLabel']},
                {id: 'divisor', name: translations[currentLang]['divisorLabel']},
                {id: 'hireDate', name: translations[currentLang]['hireDateLabel']},
                {id: 'endDate', name: translations[currentLang]['endDateLabel']}
            ];
            
            let isValid = true;
            let missingFields = [];
            let firstMissingEl = null;
            
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                const value = (element && typeof element.value === 'string') ? element.value.trim() : '';
                
                if (!value) {
                    if (element) {
                        element.classList.add('error');
                        element.classList.add('glow-yellow'); // 未填：黃色光暈
                        element.classList.remove('glow-red');
                        if (!firstMissingEl) firstMissingEl = element; // 記錄第一個未填欄位
                    }
                    missingFields.push(field.name);
                    isValid = false;
                } else if (element) {
                    element.classList.remove('error');
                    element.classList.remove('glow-yellow');
                    element.classList.remove('glow-red');
                }
            });
            
            if (!isValid) {
                const errorMsg = currentLang === 'zh' ? 
                    `錯誤：請填寫必填欄位 - ${missingFields.join('、')}` :
                    `Error: Please fill in required fields - ${missingFields.join(', ')}`;
                updateStatus(errorMsg);
                // 自動引導：聚焦、滾動到視窗中間、視覺提示
                if (firstMissingEl) {
                    try { firstMissingEl.focus(); } catch(e) {}
                    // 用自訂動畫（約 500ms），速度正常而唔會太慢；預留 80px 空間
                    scrollToElement(firstMissingEl, 1400, -80);
                    firstMissingEl.classList.add('shake');
                    setTimeout(() => firstMissingEl.classList.remove('shake'), 700);
                }
            }
            
            return isValid;
        }
        
        // 計算分數
        function calculateScore() {
            // 驗證必填字段
            if (!validateRequiredFields()) {
                return;
            }
            
            // 獲取表單值
            const salary = parseFloat(document.getElementById('salary').value) || 0;
            const divisor = parseFloat(document.getElementById('divisor').value) || 538;
            const hireDate = document.getElementById('hireDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const hire = new Date(hireDate);
            const end = new Date(endDate);
            
            // 額外邏輯檢查：海外子女不可大於子女人數
            const childrenValCalc = parseInt(document.getElementById('children').value) || 0;
            const overseasValCalc = parseInt(document.getElementById('overseas').value) || 0;
            if (overseasValCalc > childrenValCalc) {
                const overMsg = currentLang === 'zh' ? '錯誤：海外子女不可多於子女人數' : 'Error: Overseas children cannot exceed total children';
                updateStatus(overMsg);
                const overseasEl2 = document.getElementById('overseas');
                if (overseasEl2) overseasEl2.classList.add('error','glow-red');
                scrollToElement(overseasEl2, 900, -80);
                return;
            }

            if (end < hire) {
                const errorMsg = currentLang === 'zh' ? 
                    "錯誤：截止日期不能早於入職日期" : 
                    "Error: End date cannot be earlier than hire date";
                updateStatus(errorMsg);
                const endEl = document.getElementById('endDate');
    const childrenEl = document.getElementById('children');
    const overseasEl = document.getElementById('overseas');
    const newbornEl = document.getElementById('newborn');
    const otherChildrenEl = document.getElementById('otherChildren');
                const hireEl = document.getElementById('hireDate');
                if (endEl) { endEl.classList.add('error'); endEl.classList.add('glow-red'); }
                if (hireEl) { hireEl.classList.add('error'); hireEl.classList.add('glow-red'); }
                return;
            } else {
                const endEl = document.getElementById('endDate');
                const hireEl = document.getElementById('hireDate');
                if (endEl) { endEl.classList.remove('error'); endEl.classList.remove('glow-red'); }
                if (hireEl) { hireEl.classList.remove('error'); hireEl.classList.remove('glow-red'); }
            }
            
            const spouse = document.getElementById('spouse').value === 'yes';
            const children = parseInt(document.getElementById('children').value) || 0;
            const overseas = parseInt(document.getElementById('overseas').value) || 0;
            const newborn = parseInt(document.getElementById('newborn').value) || 0;
            const otherChildren = parseInt(document.getElementById('otherChildren').value) || 0;
            const instruction = document.getElementById('instruction').value === 'yes';
            const defect = document.getElementById('defect').value === 'yes';
            
            // 計算年資分數 (使用365.25日為一年)
            const oneDay = 1000 * 60 * 60 * 24;
            const days = Math.floor((end - hire) / oneDay) + 1;
            const years = days / 365.25;
            const serviceScore = years * scoringRules.serviceMultiplier;
            
            // 計算薪金分數
            const salaryScore = salary / divisor;
            
            // 家庭相關分數
            const spouseScore = spouse ? scoringRules.spouse : 0;
            const childrenScore = children * scoringRules.child;
            const overseasScore = overseas * scoringRules.overseasChild;
            const newbornScore = newborn * scoringRules.newborn;
            const otherChildrenScore = otherChildren * scoringRules.child + 
                                     (otherChildren > 0 ? scoringRules.firstChildBonus : 0);
            
            // 特殊情況分數
            const instructionScore = instruction ? scoringRules.instruction : 0;
            const defectScore = defect ? scoringRules.defect : 0;
            
            // 總分
            currentScore = salaryScore + serviceScore + spouseScore + childrenScore + 
                          overseasScore + newbornScore + otherChildrenScore + 
                          instructionScore + defectScore;
            
            // 顯示結果
            displayResult(currentScore, {
                salaryScore, serviceScore, spouseScore, childrenScore, 
                overseasScore, newbornScore, otherChildrenScore, 
                instructionScore, defectScore,
                salary, divisor, days, years
            });
            
            const successMsg = currentLang === 'zh' ? 
                `計算完成！總分: ${currentScore.toFixed(2)}` : 
                `Calculation completed! Total score: ${currentScore.toFixed(2)}`;
            updateStatus(successMsg);
            
            // 計算完成後，自動滾動到結果區域
            const resultSection = document.querySelector('.result-section');
            if (resultSection) {
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            // 套用目前 UI 設定到結果區（避免字體大小或主題未生效）
            const ui = getUiSettings();
            applyUiSettings(ui);
            }
        }
        
        // 顯示結果
        function displayResult(totalScore, details) {
            const resultContainer = document.querySelector('.result-container');
            
            // 根據語言顯示結果
            if (currentLang === 'zh') {
                resultContainer.innerHTML = `
                    <div class="highlight-score">總分: ${totalScore.toFixed(4)}</div>
                    
                    <div class="result-details">
                        <div class="result-item">
                            <div class="result-label">薪金分數</div>
                            <div class="result-value">${details.salary} ÷ ${details.divisor} = ${details.salaryScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">年資分數</div>
                            <div class="result-value">${details.days} 天 (${details.years.toFixed(2)} 年) × ${scoringRules.serviceMultiplier} = ${details.serviceScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">家庭分數</div>
                            <div class="result-value">
                                配偶: ${details.spouseScore}分 | 
                                子女: ${details.childrenScore}分 | 
                                海外: ${details.overseasScore}分 | 
                                新生: ${details.newbornScore}分 | 
                                其他: ${details.otherChildrenScore}分
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">特殊分數</div>
                            <div class="result-value">
                                指示離開: ${details.instructionScore}分 | 
                                宿舍缺陷: ${details.defectScore}分
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">詳細分數組成</div>
                            <div class="result-value">
                                薪金分數: ${details.salaryScore.toFixed(4)}<br>
                                年資分數: ${details.serviceScore.toFixed(4)}<br>
                                家庭分數: ${(details.spouseScore + details.childrenScore + details.overseasScore + details.newbornScore + details.otherChildrenScore).toFixed(4)}<br>
                                特殊分數: ${(details.instructionScore + details.defectScore).toFixed(4)}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="highlight-score">Total Score: ${totalScore.toFixed(4)}</div>
                    
                    <div class="result-details">
                        <div class="result-item">
                            <div class="result-label">Salary Score</div>
                            <div class="result-value">${details.salary} ÷ ${details.divisor} = ${details.salaryScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Service Score</div>
                            <div class="result-value">${details.days} days (${details.years.toFixed(2)} years) × ${scoringRules.serviceMultiplier} = ${details.serviceScore.toFixed(4)}</div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Family Score</div>
                            <div class="result-value">
                                Spouse: ${details.spouseScore} | 
                                Children: ${details.childrenScore} | 
                                Overseas: ${details.overseasScore} | 
                                Newborn: ${details.newbornScore} | 
                                Other: ${details.otherChildrenScore}
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Special Score</div>
                            <div class="result-value">
                                Instruction: ${details.instructionScore} | 
                                Defect: ${details.defectScore}
                            </div>
                        </div>
                        
                        <div class="result-item">
                            <div class="result-label">Score Composition</div>
                            <div class="result-value">
                                Salary Score: ${details.salaryScore.toFixed(4)}<br>
                                Service Score: ${details.serviceScore.toFixed(4)}<br>
                                Family Score: ${(details.spouseScore + details.childrenScore + details.overseasScore + details.newbornScore + details.otherChildrenScore).toFixed(4)}<br>
                                Special Score: ${(details.instructionScore + details.defectScore).toFixed(4)}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // 保存目前資料（命名：YYYYMMDD_HHMMSS_用家標籤）
        function saveCurrentData() {
            const salary = document.getElementById('salary').value;
            const divisor = document.getElementById('divisor').value;
            const hireDate = document.getElementById('hireDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!salary || !divisor || !hireDate || !endDate || currentScore === 0) {
                const errorMsg = currentLang === 'zh' ? 
                    "錯誤：請先填寫必填欄位並計算分數" : 
                    "Error: Please fill in required fields and calculate score";
                updateStatus(errorMsg);
                return;
            }

            document.getElementById('saveNoticeModal').style.display = 'flex';
        }
        
        // 添加數據卡片
        function addDataCard(name, data) {
            const dataContainer = document.querySelector('.data-container');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (noDataMessage) {
                noDataMessage.style.display = 'none';
            }
            
            const card = document.createElement('div');
            card.className = 'data-card';
            // 安全處理：避免把用戶輸入直接注入 HTML
            const safe = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
            const safeName = safe(name);
            const safeTime = safe(data.timestamp || '');
            const safeSalary = safe(data.salary || '0');
            const safeChildren = safe(data.children || '0');
            const safeSpouse = data.spouse === 'yes' ? (currentLang === 'zh' ? '是' : 'Yes') : (currentLang === 'zh' ? '否' : 'No');
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-name">${safeName}</div>
                    <div class="card-date">${safeTime}</div>
                </div>
                <div class="card-score">${safe(data.score || '0')} ${currentLang === 'zh' ? '分' : ''}</div>
                <div class="card-details">
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '薪金' : 'Salary'}</div>
                        <div class="detail-value">HK$ ${safeSalary}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '子女' : 'Children'}</div>
                        <div class="detail-value">${safeChildren} ${currentLang === 'zh' ? '人' : ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '配偶在港' : 'Spouse in HK'}</div>
                        <div class="detail-value">${safe(safeSpouse)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLang === 'zh' ? '保存時間' : 'Saved Time'}</div>
                        <div class="detail-value">${safeTime}</div>
                    </div>
                </div>
                <div class="card-actions">
                    <div class="action-btn load-btn" data-name="${safeName}">
                        <i class="fas fa-download"></i> <span>${currentLang === 'zh' ? '載入' : 'Load'}</span>
                    </div>
                    <div class="action-btn delete-btn" data-name="${safeName}">
                        <i class="fas fa-trash"></i> <span>${currentLang === 'zh' ? '刪除' : 'Delete'}</span>
                    </div>
                </div>
            `;
            
            dataContainer.prepend(card);
            
            // 添加事件監聽器
            card.querySelector('.load-btn').addEventListener('click', function() {
                loadSavedData(this.dataset.name);
            });
            
            card.querySelector('.delete-btn').addEventListener('click', function() {
                deleteSavedData(this.dataset.name);
            });
        }
        
        // 加載保存的數據
        function loadSavedData(name) {
            const savedData = JSON.parse(localStorage.getItem('dormData')) || {};
            const data = savedData[name];
            
            if (!data) {
                const errorMsg = currentLang === 'zh' ? 
                    "錯誤：找不到保存的數據" : 
                    "Error: Saved data not found";
                updateStatus(errorMsg);
                return;
            }
            
            // 填充表單
            document.getElementById('salary').value = data.salary;
            document.getElementById('divisor').value = data.divisor;
            document.getElementById('hireDate').value = data.hireDate;
            document.getElementById('endDate').value = data.endDate;
            document.getElementById('spouse').value = data.spouse;
            document.getElementById('children').value = data.children;
            document.getElementById('overseas').value = data.overseas;
            document.getElementById('newborn').value = data.newborn;
            document.getElementById('otherChildren').value = data.otherChildren;
            document.getElementById('instruction').value = data.instruction;
            document.getElementById('defect').value = data.defect;
            
            // 設置當前分數
            currentScore = parseFloat(data.score) || 0;
            
            // 顯示結果
            if (currentScore > 0) {
                calculateScore();
            }
            
            const successMsg = currentLang === 'zh' ? 
                "已載入保存的數據: " + name : 
                "Loaded saved data: " + name;
            updateStatus(successMsg);
        }
        
        // 刪除保存的數據
        function deleteSavedData(name) {
            const confirmMsg = currentLang === 'zh' ? 
                `確定要刪除「${name}」嗎？` : 
                `Are you sure you want to delete "${name}"?`;
                
            if (!confirm(confirmMsg)) return;
            
            const savedData = JSON.parse(localStorage.getItem('dormData')) || {};
            delete savedData[name];
            localStorage.setItem('dormData', JSON.stringify(savedData));
            
            // 從UI中移除卡片
            document.querySelectorAll('.data-card').forEach(card => {
                if (card.querySelector('.load-btn').dataset.name === name) {
                    card.remove();
                }
            });
            
            const successMsg = currentLang === 'zh' ? 
                "已刪除保存的數據: " + name : 
                "Deleted saved data: " + name;
            updateStatus(successMsg);
            
            // 更新數據計數
            updateDataCount();
            
            // 檢查是否還有數據
            if (Object.keys(savedData).length === 0) {
                const nd = document.getElementById('noDataMessage');
                if (nd) nd.style.display = 'block';
            }
        }
        
        // 導出所有數據
        function exportAllData() {
            const savedData = localStorage.getItem('dormData') || '{}';
            const blob = new Blob([savedData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const pad = n => String(n).padStart(2, '0');
            const now = new Date();
            // 匯出檔名時間（不含秒）：YYYY-MM-DD_HHMM
            const dateStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = `dormitory_data_backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
            
            const successMsg = currentLang === 'zh' ? 
                "已導出所有數據" : 
                "All data exported";
            updateStatus(successMsg);
        }
        
        // 導入數據
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // 驗證數據格式
                        if (typeof data !== 'object') {
                            throw new Error('無效的數據格式');
                        }
                        
                        // 保存到本地存儲
                        localStorage.setItem('dormData', JSON.stringify(data));
                        
                        // 更新UI
                        document.querySelector('.data-container').innerHTML = '';
                        document.getElementById('noDataMessage').style.display = 'none';
                        
                        for (const [name, item] of Object.entries(data)) {
                            addDataCard(name, item);
                        }
                        
                        const successMsg = currentLang === 'zh' ? 
                            `已導入數據: ${Object.keys(data).length} 筆記錄` : 
                            `Data imported: ${Object.keys(data).length} records`;
                        updateStatus(successMsg);
                        updateDataCount();
                    } catch (error) {
                        const errorMsg = currentLang === 'zh' ? 
                            `錯誤: ${error.message}` : 
                            `Error: ${error.message}`;
                        updateStatus(errorMsg);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // 更新數據計數（修正：保留並重建 #dataCount 內嵌結構，避免被覆蓋）
        function updateDataCount() {
            const savedDataRaw = localStorage.getItem('dormData');
            let savedData = {};
            try {
                savedData = savedDataRaw ? JSON.parse(savedDataRaw) : {};
            } catch (e) {
                // 若資料損壞，重設為空物件
                savedData = {};
            }
            const count = Object.keys(savedData).length;
            const dataStatusEl = document.getElementById('dataStatus');
            if (!dataStatusEl) return;
            
            // 依語言重建內容，確保 #dataCount 仍然存在於 DOM 中
            if (currentLang === 'zh') {
                dataStatusEl.innerHTML = `已儲存 <span id="dataCount">${count}</span> 筆資料`;
            } else {
                dataStatusEl.innerHTML = `<span id="dataCount">${count}</span> records saved`;
            }
        }
        
        // 加載保存的數據
        function loadAllSavedData() {
            const savedData = JSON.parse(localStorage.getItem('dormData')) || {};
            
            if (Object.keys(savedData).length === 0) {
                const nd = document.getElementById('noDataMessage');
                if (nd) nd.style.display = 'block';
                return;
            }
            
            const nd2 = document.getElementById('noDataMessage');
            if (nd2) nd2.style.display = 'none';
            
            for (const [name, data] of Object.entries(savedData)) {
                addDataCard(name, data);
            }
            
            updateDataCount();
        }
        
        // 顯示調校：字體大小與主題（亮／暗）
        // 字體縮放：只調整「內容」的文字（表單與結果區），不影響大標題與工具列
        let __baselineSizes = null;
        function captureBaselineSizes() {
            const selectors = [
                '.form-section label',
                '.form-section .input-control',
                '.result-section .highlight-score',
                '.result-section .result-container',
                '.result-section .result-item',
                '.result-section .result-label',
                '.result-section .result-value'
            ];
            __baselineSizes = {};
            selectors.forEach(sel => {
                document.querySelectorAll(sel).forEach((el, idx) => {
                    const key = sel+':'+idx;
                    const size = parseFloat(getComputedStyle(el).fontSize) || 16;
                    __baselineSizes[key] = {el, size};
                });
            });
        }
        function applyFontScale(scale) {
            if (!__baselineSizes) captureBaselineSizes();
            Object.values(__baselineSizes).forEach(({el,size}) => {
                const px = (size * scale) + 'px';
                // 使用 !important 以覆蓋樣式表中的 !important 規則（例如 h1）
                el.style.setProperty('font-size', px, 'important');
            });
        }
        function applyUiSettings(settings) {
            if (settings.fontScale) {
                applyFontScale(settings.fontScale);
            }
            const theme = settings.theme === 'light' ? 'theme-light' : 'theme-dark';
            document.documentElement.classList.remove('theme-light','theme-dark');
            document.documentElement.classList.add(theme);
            document.body.style.background = `linear-gradient(135deg, var(--primary), var(--primary-dark))`;
            document.body.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-light') || '#fff';
        }
        
        function getUiSettings() {
            try { return JSON.parse(localStorage.getItem('uiSettings')) || {}; } catch(e) { return {}; }
        }
        
        function setUiSettings(next) {
            localStorage.setItem('uiSettings', JSON.stringify(next));
            applyUiSettings(next);
        }
        
        function initUiControls() {
            const settings = getUiSettings();
            if (!settings.fontScale) settings.fontScale = 1.0; // 比例 0.8–1.6
            if (!settings.theme) settings.theme = 'dark'; // 第一次載入預設黑暗，之後記憶使用者選擇
            applyUiSettings(settings);
            const inc = document.getElementById('fontInc');
            const dec = document.getElementById('fontDec');
            const themeBtn = document.getElementById('themeToggle');
            
            if (inc) inc.addEventListener('click', () => {
                settings.fontScale = Math.min(settings.fontScale + 0.1, 1.6);
                setUiSettings(settings);
            });
            if (dec) dec.addEventListener('click', () => {
                settings.fontScale = Math.max(settings.fontScale - 0.1, 0.8);
                setUiSettings(settings);
            });
            if (themeBtn) themeBtn.addEventListener('click', () => { settings.theme = settings.theme === 'light' ? 'dark' : 'light'; setUiSettings(settings); });
            
        }
        
        // 事件監聽
        document.getElementById('calcBtn').addEventListener('click', calculateScore);
        document.getElementById('resetBtn').addEventListener('click', initForm);
        document.getElementById('saveDataBtn').addEventListener('click', saveCurrentData);
        const loadBtnEl = document.getElementById('loadBtn');
        const loadSelectEl = document.getElementById('loadSelect');
        if (loadBtnEl && loadSelectEl) {
            loadBtnEl.addEventListener('click', showLoadSelect);
            loadSelectEl.addEventListener('change', function() {
                const name = this.value;
                if (name) loadSavedData(name);
                // 選擇後收起下拉
                this.style.display = 'none';
            });
        }
        const cancelSaveBtn = document.getElementById('cancelSaveBtn');
        const deleteSelectEl = document.getElementById('deleteSelect');
        if (cancelSaveBtn && deleteSelectEl) {
            cancelSaveBtn.addEventListener('click', showDeleteSelect);
            deleteSelectEl.addEventListener('change', function() {
                const name = this.value;
                if (!name) { this.style.display = 'none'; return; }
                if (name === '__DELETE_ALL__') {
                    deleteAllSavedData();
                } else {
                    deleteSavedData(name);
                }
                this.style.display = 'none';
            });
        }
        
        // 顯示載入選單並填入所有儲存的檔名（依建立時間新到舊）
        function showLoadSelect() {
            let savedData = {};
            try { savedData = JSON.parse(localStorage.getItem('dormData')) || {}; } catch(e) { savedData = {}; }
            const keys = Object.keys(savedData);
            if (keys.length === 0) {
                const msg = currentLang === 'zh' ? "沒有可載入的資料" : "No data to load";
                updateStatus(msg);
                return;
            }
            // 排序：按 createdAt 降序（新到舊）；沒有 createdAt 的放最後
            keys.sort((a,b) => (savedData[b].createdAt||0) - (savedData[a].createdAt||0));
            const sel = document.getElementById('loadSelect');
            sel.innerHTML = '';
            // 先加一個提示選項
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = currentLang === 'zh' ? '選擇要載入的檔名…' : 'Select a record to load…';
            sel.appendChild(placeholder);
            for (const k of keys) {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                sel.appendChild(opt);
            }
            sel.style.display = 'inline-block';
            sel.focus();
        }
        
        // 顯示刪除選單（包含「刪除全部」及所有檔名）
        function showDeleteSelect() {
            let savedData = {};
            try { savedData = JSON.parse(localStorage.getItem('dormData')) || {}; } catch(e) { savedData = {}; }
            const keys = Object.keys(savedData);
            if (keys.length === 0) {
                const msg = currentLang === 'zh' ? '目前沒有可刪除的資料' : 'No saved record to delete';
                updateStatus(msg);
                return;
            }
            // 排序（新到舊）
            keys.sort((a,b) => (savedData[b].createdAt||0) - (savedData[a].createdAt||0));
            const sel = document.getElementById('deleteSelect');
            sel.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = currentLang === 'zh' ? '選擇要刪除的檔名…' : 'Select a record to delete…';
            sel.appendChild(placeholder);
            const deleteAll = document.createElement('option');
            deleteAll.value = '__DELETE_ALL__';
            deleteAll.textContent = currentLang === 'zh' ? '刪除全部（Danger）' : 'Delete ALL (Danger)';
            sel.appendChild(deleteAll);
            for (const k of keys) {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                sel.appendChild(opt);
            }
            sel.style.display = 'inline-block';
            sel.focus();
        }
        
        // 刪除全部儲存資料
        function deleteAllSavedData() {
            if (!confirm(currentLang === 'zh' ? '確定要刪除全部儲存資料嗎？此操作不可恢復。' : 'Delete ALL saved records? This action cannot be undone.')) return;
            localStorage.removeItem('dormData');
            document.querySelector('.data-container')?.replaceChildren();
            const nd = document.getElementById('noDataMessage');
            if (nd) nd.style.display = 'block';
            updateDataCount();
            const msg = currentLang === 'zh' ? '已刪除全部儲存資料' : 'All saved records deleted';
            updateStatus(msg);
        }
        
        // 標題自適應：根據容器寬度自動縮放，保證單行完整顯示
        let __fitTitleRaf = null;
        function fitTitle() {
            if (__fitTitleRaf) cancelAnimationFrame(__fitTitleRaf);
            __fitTitleRaf = requestAnimationFrame(() => {
                const header = document.querySelector('header');
                const h1 = header ? header.querySelector('h1') : null;
                if (!h1 || !header) return;
                const maxPx = 32; // 大屏最高
                const minPx = 16; // 小屏最低
                let size = maxPx;
                h1.style.setProperty('font-size', size + 'px', 'important');
                const isEn = (typeof currentLang !== 'undefined') && currentLang === 'en';
                h1.style.setProperty('white-space', isEn ? 'normal' : 'nowrap', 'important');
                const available = header.clientWidth - 24; // 預留左右邊距
                let steps = 0;
                while (h1.scrollWidth > available && size > minPx && steps < 24) {
                    size -= 1;
                    h1.style.setProperty('font-size', size + 'px', 'important');
                    steps++;
                }
            });
        }
        // 視窗改變時重新適配（防抖）
        let __fitTitleTimer = null;
        window.addEventListener('resize', () => {
            clearTimeout(__fitTitleTimer);
            __fitTitleTimer = setTimeout(fitTitle, 120);
        });
        
        // 即時（Live）驗證：在輸入時就提示
function validateLiveFields() {
    // 必填：薪金、除數、入職、截止
    const salaryEl = document.getElementById('salary');
    const divisorEl = document.getElementById('divisor');
    const hireEl = document.getElementById('hireDate');
    const endEl = document.getElementById('endDate');
    const childrenEl = document.getElementById('children');
    const overseasEl = document.getElementById('overseas');
    const newbornEl = document.getElementById('newborn');
    const otherChildrenEl = document.getElementById('otherChildren');

    const salary = parseFloat((salaryEl && salaryEl.value) || '');
    const divisor = parseFloat((divisorEl && divisorEl.value) || '');
    const hire = new Date((hireEl && hireEl.value) || '');
    const end = new Date((endEl && endEl.value) || '');
    const childrenVal = parseFloat((childrenEl && childrenEl.value) || '0');
    const overseasVal = parseFloat((overseasEl && overseasEl.value) || '0');
    const newbornVal = parseFloat((newbornEl && newbornEl.value) || '0');
    const otherChildrenVal = parseFloat((otherChildrenEl && otherChildrenEl.value) || '0');

    // 清理舊狀態
    [salaryEl, divisorEl, hireEl, endEl, childrenEl, overseasEl, newbornEl, otherChildrenEl].forEach(el => { if (el) { el.classList.remove('glow-yellow','glow-red'); el.classList.remove('error'); } });

    // 空白提示：黃色光
    [{el: salaryEl},{el: divisorEl},{el: hireEl},{el: endEl},{el: childrenEl},{el: overseasEl},{el: newbornEl},{el: otherChildrenEl}].forEach(item => {
        if (item.el && item.el.value === '') { item.el.classList.add('glow-yellow'); }
    });

    // 數值基本檢查
    if (salaryEl && !isNaN(salary) && salary < 0) { salaryEl.classList.add('error','glow-red'); }
    if (divisorEl && !isNaN(divisor) && divisor < 1) { divisorEl.classList.add('error','glow-red'); }

    // 非負整數檢查（子女、海外、新生、其他子女）
    function isNonNegativeInteger(n){ return Number.isInteger(n) && n >= 0; }
    if (childrenEl && !isNonNegativeInteger(childrenVal)) { childrenEl.classList.add('error','glow-red'); }
    if (overseasEl && !isNonNegativeInteger(overseasVal)) { overseasEl.classList.add('error','glow-red'); }
    if (newbornEl && !isNonNegativeInteger(newbornVal)) { newbornEl.classList.add('error','glow-red'); }
    if (otherChildrenEl && !isNonNegativeInteger(otherChildrenVal)) { otherChildrenEl.classList.add('error','glow-red'); }

    // 邏輯檢查：海外子女人數不可大於子女人數
    if (childrenEl && overseasEl && isNonNegativeInteger(childrenVal) && isNonNegativeInteger(overseasVal)) {
        if (overseasVal > childrenVal) {
            overseasEl.classList.add('error','glow-red');
            const msg = currentLang === 'zh' ? '錯誤：海外子女不可多於子女人數' : 'Error: Overseas children cannot exceed total children';
            updateStatus(msg);
        }
    }

    // 日期先做基本：都填咗先檢查先後
    if (hire.toString() !== 'Invalid Date' && end.toString() !== 'Invalid Date') {
        if (end < hire) {
            // 即時錯誤提示（跟語言）
            const msg = currentLang === 'zh' ? "錯誤：截止日期不能早於入職日期" : "Error: End date cannot be earlier than hire date";
            updateStatus(msg);
            if (endEl) endEl.classList.add('error','glow-red');
            if (hireEl) hireEl.classList.add('error','glow-red');
        }
    }
}

function attachLiveValidation() {
    const ids = ['salary','divisor','hireDate','endDate'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        ['input','change','blur'].forEach(evt => el.addEventListener(evt, validateLiveFields));
    });
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
            initForm();
            loadAllSavedData();
            setLanguage('zh');
            initUiControls();
            fitTitle();
            attachLiveValidation();
            validateLiveFields();
            // 綁定「使用須知」彈窗事件
            const infoBtn = document.getElementById('infoBtn');
            const overlay = document.getElementById('infoOverlay');
            const modal = document.getElementById('infoModal');
            const closeBtn = document.getElementById('closeModal');
            const closeX = document.getElementById('closeModalX');
            function openInfo() {
                if (!overlay || !modal) return;
                overlay.style.display = 'block';
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden', 'false');
                overlay.setAttribute('aria-hidden', 'false');
            }
            function closeInfo() {
                if (!overlay || !modal) return;
                overlay.style.display = 'none';
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                overlay.setAttribute('aria-hidden', 'true');
            }
            if (infoBtn) infoBtn.addEventListener('click', openInfo);
            // 事件委派保險：即使按鈕未綁定亦可正常開窗
            document.addEventListener('click', function(e){
                const btn = e.target.closest('#infoBtn');
                if (btn) { e.preventDefault(); openInfo(); }
            });
            if (closeBtn) closeBtn.addEventListener('click', closeInfo);
            if (closeX) closeX.addEventListener('click', closeInfo);
            if (overlay) overlay.addEventListener('click', closeInfo);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeInfo(); });
        });
    

        function proceedSave() {
            document.getElementById('saveNoticeModal').style.display = 'none';

            const salary = document.getElementById('salary').value;
            const divisor = document.getElementById('divisor').value;
            const hireDate = document.getElementById('hireDate').value;
            const endDate = document.getElementById('endDate').value;

            const now = new Date();
            const dateStr = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                String(now.getMinutes()).padStart(2, '0');
            const defaultName = dateStr + '_' + timeStr;

            const recordName = prompt(
                currentLang === 'zh' ? '請輸入記錄名稱(選填)：' : 'Enter record name (optional):',
                defaultName
            );

            if (recordName === null) return;

            const data = {
                name: recordName || defaultName,
                salary: salary,
                divisor: divisor,
                hireDate: hireDate,
                endDate: endDate,
                spouse: document.getElementById('spouse').value,
                children: document.getElementById('children').value,
                overseas: document.getElementById('overseas').value,
                newborn: document.getElementById('newborn').value,
                otherChildren: document.getElementById('otherChildren').value,
                instruction: document.getElementById('instruction').value,
                defect: document.getElementById('defect').value,
                score: currentScore,
                timestamp: now.toLocaleString(currentLang === 'zh' ? 'zh-HK' : 'en-US')
            };

            let records = JSON.parse(localStorage.getItem('dormRecords') || '[]');
            records.push(data);
            localStorage.setItem('dormRecords', JSON.stringify(records));

            const msg = currentLang === 'zh' ? 
                '✅ 資料已儲存到您的設備' : 
                '✅ Data saved to your device';
            updateStatus(msg);

            if (typeof loadAllSavedData === 'function') {
                loadAllSavedData();
            }
        }

    </script>
        <div id="infoOverlay" class="modal-overlay" aria-hidden="true"></div>
        <div id="infoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="infoTitle" aria-hidden="true">
            <header>
                <h3 id="infoTitle"><i class="fas fa-info-circle"></i> 使用須知</h3>
                <button id="closeModalX" class="btn btn-warning no-text-shadow btn-small" aria-label="關閉"><i class="fas fa-times"></i></button>
            </header>
            <div class="modal-body">
                <p id="scoringLabel" class="label">計分準則（簡述）：</p>
                <ul>
                    <li id="salaryRule">薪金分數：薪金 ÷ 除數（預設 538）。</li>
                    <li id="serviceRule">年資分數：入職至截止日期的天數 ÷ 365.25 × 年資乘數（預設 6）。</li>
                    <li id="familyRule">家庭加分：配偶 +20；每名子女 +10；海外就讀子女 +5；新生 +10；其他子女（除首名）按子女分數並可能有首名加成 +20。</li>
                    <li id="specialRule">特殊情況：被指示離開 +72；宿舍有缺陷 +20。</li>
                </ul>
                <p id="noticeLabel" class="label">注意事項：</p>
                <ul>
                    <li id="refOnlyRule">此計算結果僅供參考，參數或規則可能會改變；請自行核實。</li>
                    <li id="dateRule">請確保日期輸入正確（截止日期不可早於入職日期）。</li>
                    <li id="storageRule">本工具只在瀏覽器本機儲存資料（localStorage），不會上載伺服器；請自行妥善保管。</li>
                    <li id="privacyRule">本工具僅在瀏覽器本機處理及儲存資料；資料不會傳送到任何伺服器或第三方。</li>
                    <li id="liabilityRule">任何因使用本工具而引致的後果或損失，本工具不承擔責任。</li>
                </ul>
            </div>
            <div class="modal-foot">
                <button id="closeModal" class="close-btn"><span id="closeModalText">我明白</span></button>
            </div>
        </div>

    <div id="saveNoticeModal" class="modal-overlay" style="display: none;">
        <div class="modal" style="display: block;">
            <header>
                <h3>
                    <i class="fas fa-save"></i> 
                    <span class="lang-zh">儲存確認</span>
                    <span class="lang-en" style="display:none;">Save Confirmation</span>
                </h3>
            </header>
            <div class="modal-body">
                <p style="font-size: 1.05rem; margin-bottom: 12px;">
                    <span class="lang-zh">資料將儲存於您的設備。</span>
                    <span class="lang-en" style="display:none;">Data will be saved on your device.</span>
                </p>
                <p style="font-size: 0.9rem; color: #aaa;">
                    <span class="lang-zh">（不會上傳伺服器，請自行備份）</span>
                    <span class="lang-en" style="display:none;">(Not uploaded to server, please backup yourself)</span>
                </p>
            </div>
            <div class="modal-foot">
                <button onclick="proceedSave()" class="btn btn-success" style="margin-right: 10px;">
                    <span class="lang-zh">✓ 確認</span>
                    <span class="lang-en" style="display:none;">✓ Confirm</span>
                </button>
                <button onclick="document.getElementById('saveNoticeModal').style.display='none'" class="btn btn-danger">
                    <span class="lang-zh">✕ 取消</span>
                    <span class="lang-en" style="display:none;">✕ Cancel</span>
                </button>
            </div>
        </div>
    </div>

</body>
</html>